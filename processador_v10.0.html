<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analisador de Rotas V10.0 - Sistema Completo</title>

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- XLSX para planilhas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- Papa Parse para CSV robusto (NOVO) -->
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

    <!-- Leaflet.js para mapas (NOVO) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- PDF.js para leitura de PDFs (NOVO) -->
    <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
    <script>
        // Configurar worker do PDF.js
        if (typeof pdfjsLib !== 'undefined') {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js';
        }
    </script>

    <style>
        /* ===== VARI√ÅVEIS CSS PARA TEMAS ===== */
        :root {
            --bg-primary: #f8fafc;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f1f5f9;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --border-color: #e2e8f0;
            --shadow: rgba(0, 0, 0, 0.06);
            --gradient-start: #1e293b;
            --gradient-end: #0f172a;
        }

        [data-theme="dark"] {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --border-color: #475569;
            --shadow: rgba(0, 0, 0, 0.3);
            --gradient-start: #475569;
            --gradient-end: #334155;
        }

        /* ===== ESTILOS BASE ===== */
        body {
            background-color: var(--bg-primary);
            padding: 25px;
            font-family: 'Segoe UI', system-ui, sans-serif;
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }

        .card {
            border: none;
            box-shadow: 0 10px 30px var(--shadow);
            border-radius: 16px;
            margin-bottom: 25px;
            background-color: var(--bg-secondary);
            border-color: var(--border-color);
        }

        .header-section {
            background: linear-gradient(135deg, var(--gradient-start) 0%, var(--gradient-end) 100%);
            color: white;
            padding: 40px;
            text-align: center;
            border-radius: 16px 16px 0 0;
        }

        #drop-area {
            border: 2px dashed #94a3b8;
            border-radius: 12px;
            padding: 40px;
            background: var(--bg-secondary);
            cursor: pointer;
            transition: 0.2s;
        }
        #drop-area:hover { border-color: #3b82f6; background-color: var(--bg-tertiary); }
        #drop-area.processing { border-color: #f59e0b; background-color: #fffbeb; cursor: wait; }

        /* ===== BADGES ===== */
        .badge-stop {
            background-color: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
            padding: 5px 10px;
            border-radius: 6px;
            font-weight: 600;
        }
        .badge-move {
            background-color: #eff6ff;
            color: #1d4ed8;
            border: 1px solid #93c5fd;
            padding: 5px 10px;
            border-radius: 6px;
            font-weight: 600;
        }
        .badge-bairro {
            background-color: #f0fdf4;
            color: #166534;
            border: 1px solid #86efac;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.75em;
            font-weight: 500;
        }

        [data-theme="dark"] .badge-stop {
            background-color: #7f1d1d;
            color: #fca5a5;
        }

        [data-theme="dark"] .badge-move {
            background-color: #1e3a8a;
            color: #93c5fd;
        }

        /* ===== BOT√ïES ===== */
        .btn-route {
            background-color: #2563eb;
            color: white;
            text-decoration: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.9em;
            transition: 0.2s;
            border: none;
        }
        .btn-route:hover { background-color: #1e40af; color: white; transform: translateY(-1px); }

        .btn-date { min-width: 60px; margin: 3px; border-radius: 20px; font-weight: 600; font-size: 0.9em; }

        /* ===== CAIXAS DE INFO ===== */
        .info-box { background: #fffbeb; border-left: 4px solid #f59e0b; padding: 15px; border-radius: 4px; font-size: 0.9em; color: #92400e; margin-bottom: 20px; }
        .success-box { background: #f0fdf4; border-left: 4px solid #22c55e; padding: 15px; border-radius: 4px; font-size: 0.9em; color: #166534; margin-bottom: 20px; }
        .error-box { background: #fef2f2; border-left: 4px solid #ef4444; padding: 15px; border-radius: 4px; font-size: 0.9em; color: #991b1b; margin-bottom: 20px; }

        /* ===== DETAILS/SUMMARY ===== */
        details summary { list-style: none; cursor: pointer; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        details summary::-webkit-details-marker { display: none; }
        details summary::after { content: '+'; font-size: 1.5em; font-weight: normal; }
        details[open] summary::after { content: '-'; }
        .rules-list li { margin-bottom: 6px; }

        .stats-badge { display: inline-block; background: #e0e7ff; color: #3730a3; padding: 4px 10px; border-radius: 12px; font-size: 0.85em; margin: 2px; }

        /* ===== FILTRO DE BAIRROS ===== */
        .filter-section {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .filter-title { font-weight: 600; color: var(--text-secondary); margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }
        .bairro-chip {
            display: inline-flex;
            align-items: center;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            padding: 4px 10px;
            border-radius: 20px;
            margin: 3px;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.2s;
        }
        .bairro-chip:hover { border-color: #3b82f6; background: #eff6ff; }
        .bairro-chip.active { background: #3b82f6; color: white; border-color: #3b82f6; }
        .bairro-chip .count { background: rgba(0,0,0,0.1); padding: 1px 6px; border-radius: 10px; margin-left: 6px; font-size: 0.8em; }
        .bairro-chip.active .count { background: rgba(255,255,255,0.3); }
        .filter-actions { margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border-color); }

        .highlight-row { background-color: #fefce8 !important; }

        /* ===== TABELA ===== */
        .table {
            color: var(--text-primary);
        }

        .table-hover tbody tr:hover {
            background-color: var(--bg-tertiary);
        }

        [data-theme="dark"] .text-muted {
            color: var(--text-secondary) !important;
        }

        [data-theme="dark"] #drop-area {
            background-color: var(--bg-tertiary);
            border-color: var(--border-color);
        }

        /* ===== PROGRESS OVERLAY ===== */
        #progress-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
        }
        .progress-container {
            background: white;
            padding: 40px;
            border-radius: 16px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        /* ===== TOAST CONTAINER ===== */
        #toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
        }
        .toast-custom {
            min-width: 300px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            border-radius: 12px;
            border: none;
        }
        .toast-success { border-left: 4px solid #22c55e; }
        .toast-error { border-left: 4px solid #ef4444; }
        .toast-warning { border-left: 4px solid #f59e0b; }
        .toast-info { border-left: 4px solid #3b82f6; }

        /* ===== RESPONSIVIDADE MOBILE ===== */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .header-section {
                padding: 20px 15px;
            }

            .header-section h2 {
                font-size: 1.3rem;
            }

            .table-responsive {
                font-size: 0.85em;
            }

            .badge-stop, .badge-move {
                font-size: 0.7em;
                padding: 3px 6px;
            }

            .badge-bairro {
                font-size: 0.65em;
                padding: 2px 5px;
            }

            .btn-date {
                min-width: 50px;
                font-size: 0.8em;
                padding: 4px 8px;
            }

            .bairro-chip {
                font-size: 0.75em;
                padding: 3px 8px;
            }

            .btn-route {
                font-size: 0.75em;
                padding: 4px 8px;
            }

            .progress-container {
                padding: 20px;
                max-width: 90%;
            }

            .progress {
                width: 100% !important;
                max-width: 250px;
            }
        }

        @media (hover: none) and (pointer: coarse) {
            .bairro-chip,
            .btn-date,
            .btn-route {
                min-height: 44px;
                display: inline-flex;
                align-items: center;
                justify-content: center;
            }
        }

        /* ===== MAPA ===== */
        #map-container {
            z-index: 1;
        }

        .leaflet-popup-content {
            font-family: 'Segoe UI', system-ui, sans-serif;
            font-size: 0.9em;
        }

        /* ===== ESTAT√çSTICAS ===== */
        .stat-card {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            transition: transform 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
        }

        .stat-icon {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .stat-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #1e293b;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.85em;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        [data-theme="dark"] .stat-card {
            background: linear-gradient(135deg, #334155 0%, #1e293b 100%);
        }

        [data-theme="dark"] .stat-value {
            color: #f1f5f9;
        }

        /* ===== BUSCA ===== */
        .search-highlight {
            background-color: #fef08a !important;
        }

        /* ===== ALERTAS ===== */
        .alert-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.7em;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
    </style>
</head>

<body>

    <div class="container" style="max-width: 1200px;">
        <div class="card">
            <div class="header-section">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div style="flex: 1;"></div>
                    <h2 class="fw-bold mb-0" style="flex: 2; text-align: center;">Analisador de Rotas V10.0</h2>
                    <div style="flex: 1; text-align: right;">
                        <button id="help-toggle" class="btn btn-sm btn-outline-light me-2" type="button" title="Ajuda e Atalhos" onclick="HelpManager.toggle()">
                            <span>‚ùì</span>
                        </button>
                        <button id="theme-toggle" class="btn btn-sm btn-outline-light" type="button" title="Alternar tema">
                            <span id="theme-icon">üåô</span>
                        </button>
                    </div>
                </div>
                <p class="opacity-75 mb-0">Sistema Completo de An√°lise de Itiner√°rios</p>
            </div>
            <div class="card-body p-4">

                <div class="info-box">
                    <details>
                        <summary><span>‚ö° Regras e L√≥gica (Clique para expandir)</span></summary>
                        <div class="mt-3 pt-2 border-top border-warning border-opacity-25">
                            <ul class="rules-list ps-3 mb-0">
                                <li><strong>1. Filtro de Ru√≠do:</strong> Eventos de sistema ("Plug-In", "Sim Info", "Estou vivo!") ignorados.</li>
                                <li><strong>2. Movimento:</strong> Velocidade > 1.0 km/h conta como deslocamento.</li>
                                <li><strong>3. Corre√ß√£o GPS:</strong> Movimentos < 1 min convertidos em Parada.</li>
                                <li><strong>4. Corre√ß√£o Od√¥metro:</strong> Deslocamentos com 0 km e dura√ß√£o ‚â• 2 min s√£o convertidos em Parada.</li>
                                <li><strong>5. Fus√£o:</strong> Paradas < 2 min OU (com frenagem E < 5 min) s√£o fundidas ao deslocamento.</li>
                                <li><strong>6. Valida√ß√£o GPS:</strong> Coordenadas fora do Brasil s√£o ignoradas.</li>
                                <li><strong>7. Meia-noite:</strong> Trajetos que cruzam a meia-noite s√£o calculados corretamente.</li>
                                <li><strong>8. Filtro de Bairro:</strong> Filtre os resultados por bairros espec√≠ficos.</li>
                            </ul>
                        </div>
                    </details>
                </div>

                <div id="drop-area">
                    <div id="drop-content">
                        <h4 class="text-secondary">üìÇ Carregar Planilha (XLSX/CSV/PDF)</h4>
                        <p class="text-muted small">Arraste o arquivo aqui ou clique para selecionar</p>
                    </div>
                    <input type="file" id="fileInput" accept=".csv, .xlsx, .xls, .pdf" style="display: none;">
                </div>

                <div id="stats-area" class="mt-3" style="display: none;"></div>

                <div id="export-controls" class="mt-4" style="display: none;">
                    <div class="card bg-light border-0 mb-3">
                        <div class="card-body">
                            <h6 class="fw-bold text-secondary mb-3">üìÖ Selecione os dias para exportar:</h6>
                            <div id="export-dates-container" class="d-flex flex-wrap gap-3 justify-content-center mb-3"></div>
                            <div class="d-flex justify-content-center gap-2">
                                <button class="btn btn-sm btn-outline-secondary" type="button" id="btn-select-all-export">Marcar Todos</button>
                                <button class="btn btn-sm btn-outline-secondary" type="button" id="btn-clear-all-export">Desmarcar Todos</button>
                            </div>
                        </div>
                    </div>
                    <div class="text-center">
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-dark btn-lg dropdown-toggle shadow"
                                    data-bs-toggle="dropdown" aria-expanded="false">
                                üì¶ Exportar Relat√≥rio
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" id="export-html">üìÑ HTML Port√°til (Completo)</a></li>
                                <li><a class="dropdown-item" href="#" id="export-csv">üìä CSV (Excel)</a></li>
                                <li><a class="dropdown-item" href="#" id="export-json">üíæ JSON (Dados Brutos)</a></li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div id="date-navigation" class="d-flex flex-wrap gap-2 justify-content-center mt-4 p-3 bg-light rounded"></div>
            </div>
        </div>

        <!-- Filtro de Bairros -->
        <div id="filter-section" class="filter-section" style="display: none;">
            <div class="filter-title" style="cursor: pointer;" onclick="FilterManager.toggleBairros()">
                <span>üèòÔ∏è Filtrar por Bairro</span>
                <small class="text-muted fw-normal">(clique para selecionar/deselecionar)</small>
                <button class="btn btn-sm btn-outline-secondary ms-auto" type="button" id="toggle-bairros-btn">
                    <span id="toggle-bairros-icon">‚ñº</span> <span id="toggle-bairros-text">Mostrar</span>
                </button>
            </div>
            <div id="bairros-container" class="d-flex flex-wrap" style="display: none !important;"></div>
            <div id="filter-actions-container" class="filter-actions d-flex gap-2 flex-wrap align-items-center" style="display: none !important;">
                <button class="btn btn-sm btn-outline-primary" type="button" id="btn-select-all">Todos</button>
                <button class="btn btn-sm btn-outline-secondary" type="button" id="btn-clear-all">Nenhum</button>
                <button class="btn btn-sm btn-outline-success" type="button" id="btn-invert">Inverter</button>
                <span class="ms-auto text-muted small" id="filter-status"></span>
            </div>
        </div>

        <!-- Busca -->
        <div id="search-section" class="filter-section" style="display: none;">
            <div class="filter-title">
                <span>üîç Buscar</span>
                <small class="text-muted fw-normal">(endere√ßo, bairro, hor√°rio...)</small>
            </div>
            <div class="d-flex gap-2 align-items-center">
                <input type="text" id="search-input" class="form-control" placeholder="üîç Buscar por endere√ßo, bairro, hora..." autocomplete="off">
                <button id="search-clear" class="btn btn-outline-secondary" type="button" style="display: none;">‚úï</button>
            </div>
            <div id="search-results" class="mt-2 small text-muted"></div>
        </div>

        <!-- Estat√≠sticas Avan√ßadas -->
        <div id="advanced-stats" class="card mb-3" style="display: none;">
            <div class="card-header d-flex justify-content-between align-items-center" style="background: linear-gradient(135deg, var(--gradient-start) 0%, var(--gradient-end) 100%); color: white;">
                <h6 class="mb-0">üìä Estat√≠sticas Avan√ßadas</h6>
                <div>
                    <button class="btn btn-sm btn-outline-light" type="button" onclick="StatsManager.refresh()">üîÑ</button>
                    <button class="btn btn-sm btn-outline-light" type="button" onclick="AlertsManager.show()">‚ö†Ô∏è Alertas</button>
                    <button class="btn btn-sm btn-outline-light" type="button" onclick="CostCalculator.show()">üí∞ Custos</button>
                    <button class="btn btn-sm btn-outline-light" type="button" onclick="ComparisonManager.show()">‚öñÔ∏è Comparar Dias</button>
                    <button class="btn btn-sm btn-outline-light" type="button" onclick="LocationSearchManager.show()">üìç Buscar Local</button>
                    <button class="btn btn-sm btn-outline-light" type="button" onclick="TopLocationsManager.show()">üèÜ Top Locais</button>
                </div>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-icon">‚è±Ô∏è</div>
                            <div class="stat-value" id="stat-movement-time">--</div>
                            <div class="stat-label">Tempo em Movimento</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-icon">üõë</div>
                            <div class="stat-value" id="stat-stop-time">--</div>
                            <div class="stat-label">Tempo Parado</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-icon">üèÅ</div>
                            <div class="stat-value" id="stat-total-distance">--</div>
                            <div class="stat-label">Dist√¢ncia Total</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-icon">‚ö°</div>
                            <div class="stat-value" id="stat-avg-speed">--</div>
                            <div class="stat-label">Velocidade M√©dia</div>
                        </div>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-6">
                        <h6 class="text-secondary mb-2">üèòÔ∏è Top 5 Bairros</h6>
                        <div id="top-bairros" class="list-group list-group-flush"></div>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-secondary mb-2">‚è∞ Hor√°rios de Pico</h6>
                        <div id="peak-hours" class="list-group list-group-flush"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mapa Interativo -->
        <div id="map-section" class="card mb-3" style="display: none;">
            <div class="card-header bg-white d-flex justify-content-between align-items-center flex-wrap gap-2">
                <h6 class="mb-0">üó∫Ô∏è Visualiza√ß√£o de Rotas</h6>
                <div class="d-flex gap-2 align-items-center flex-wrap">
                    <button class="btn btn-sm btn-primary" type="button" onclick="MapTourManager.start()" id="tour-start-btn">
                        üé¨ Iniciar Tour
                    </button>
                    <div id="tour-controls" style="display: none;">
                        <div class="btn-group btn-group-sm" role="group">
                            <button class="btn btn-outline-secondary" type="button" onclick="MapTourManager.previous()" id="tour-prev-btn">
                                ‚¨ÖÔ∏è Anterior
                            </button>
                            <button class="btn btn-outline-secondary" type="button" disabled id="tour-info-btn">
                                <span id="tour-counter">0/0</span>
                            </button>
                            <button class="btn btn-outline-secondary" type="button" onclick="MapTourManager.next()" id="tour-next-btn">
                                Pr√≥ximo ‚û°Ô∏è
                            </button>
                        </div>
                        <button class="btn btn-sm btn-outline-danger ms-2" type="button" onclick="MapTourManager.stop()">
                            ‚èπÔ∏è Parar
                        </button>
                    </div>
                    <button class="btn btn-sm btn-outline-primary" type="button" onclick="MapManager.fitBounds()">üîç Ajustar Zoom</button>
                    <button class="btn btn-sm btn-outline-secondary" type="button" onclick="MapManager.toggle()">‚úï Fechar</button>
                </div>
            </div>
            <div id="tour-info-box" class="alert alert-info m-3" style="display: none;">
                <div class="d-flex justify-content-between align-items-start">
                    <div style="flex: 1;">
                        <h6 class="alert-heading mb-2" id="tour-point-title">Ponto 1</h6>
                        <div id="tour-point-details" class="small"></div>
                    </div>
                    <span class="badge bg-info" id="tour-point-type">Parada</span>
                </div>
            </div>
            <div id="map-container" style="height: 500px;"></div>
        </div>

        <!-- Compara√ß√£o Entre Dias -->
        <div id="comparison-section" class="card mb-3" style="display: none;">
            <div class="card-header d-flex justify-content-between align-items-center" style="background: linear-gradient(135deg, var(--gradient-start) 0%, var(--gradient-end) 100%); color: white;">
                <h6 class="mb-0">‚öñÔ∏è Compara√ß√£o Entre Dias</h6>
                <button class="btn btn-sm btn-outline-light" type="button" onclick="ComparisonManager.hide()">‚úï Fechar</button>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-5">
                        <label class="form-label fw-bold">üìÖ Dia A</label>
                        <select id="compare-date-a" class="form-select"></select>
                    </div>
                    <div class="col-md-2 text-center d-flex align-items-end justify-content-center">
                        <button class="btn btn-primary" type="button" onclick="ComparisonManager.compare()">‚öñÔ∏è Comparar</button>
                    </div>
                    <div class="col-md-5">
                        <label class="form-label fw-bold">üìÖ Dia B</label>
                        <select id="compare-date-b" class="form-select"></select>
                    </div>
                </div>
                <div id="comparison-results"></div>
            </div>
        </div>

        <!-- Busca por Proximidade Geogr√°fica -->
        <div id="location-search-section" class="card mb-3" style="display: none;">
            <div class="card-header d-flex justify-content-between align-items-center" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;">
                <h6 class="mb-0">üìç Busca por Proximidade Geogr√°fica</h6>
                <button class="btn btn-sm btn-outline-light" type="button" onclick="LocationSearchManager.hide()">‚úï Fechar</button>
            </div>
            <div class="card-body">
                <div class="row g-3 mb-3">
                    <div class="col-md-3">
                        <label class="form-label fw-bold">üìç Latitude</label>
                        <input type="number" id="search-latitude" class="form-control" placeholder="-6.35902" step="0.000001">
                        <small class="text-muted">Ex: -6.35902</small>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-bold">üìç Longitude</label>
                        <input type="number" id="search-longitude" class="form-control" placeholder="-39.29225" step="0.000001">
                        <small class="text-muted">Ex: -39.29225</small>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-bold">üìè Raio (metros)</label>
                        <input type="number" id="search-radius" class="form-control" placeholder="100" value="100" min="10" max="5000">
                        <small class="text-muted">10m - 5000m</small>
                    </div>
                    <div class="col-md-3 d-flex align-items-end">
                        <button class="btn btn-success w-100" type="button" onclick="LocationSearchManager.search()">
                            üîç Buscar
                        </button>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">üìÖ Selecione os Dias para Buscar</label>
                    <div id="location-search-dates" class="d-flex flex-wrap gap-2"></div>
                    <div class="mt-2">
                        <button class="btn btn-sm btn-outline-secondary" type="button" onclick="LocationSearchManager.selectAllDates()">‚úì Todos</button>
                        <button class="btn btn-sm btn-outline-secondary" type="button" onclick="LocationSearchManager.clearAllDates()">‚úó Nenhum</button>
                    </div>
                </div>

                <div id="location-search-results" style="display: none;">
                    <hr>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0">üìä Resultados da Busca</h6>
                        <div>
                            <span class="badge bg-success" id="location-results-count">0 ocorr√™ncias</span>
                            <button class="btn btn-sm btn-primary ms-2" type="button" onclick="LocationSearchManager.plotOnMap()">
                                üó∫Ô∏è Ver no Mapa
                            </button>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>#</th>
                                    <th>üìÖ Data</th>
                                    <th>üïê Hora In√≠cio</th>
                                    <th>üïê Hora Fim</th>
                                    <th>‚è±Ô∏è Dura√ß√£o</th>
                                    <th>üìç Coordenadas</th>
                                    <th>üìè Dist√¢ncia</th>
                                    <th>üìç Local</th>
                                    <th>üó∫Ô∏è</th>
                                </tr>
                            </thead>
                            <tbody id="location-search-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Top 10 Locais Mais Visitados -->
        <div id="top-locations-section" class="card mb-3" style="display: none;">
            <div class="card-header d-flex justify-content-between align-items-center" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white;">
                <h6 class="mb-0">üèÜ Top 10 Locais Mais Visitados</h6>
                <button class="btn btn-sm btn-outline-light" type="button" onclick="TopLocationsManager.hide()">‚úï Fechar</button>
            </div>
            <div class="card-body">
                <div class="row g-3 mb-3">
                    <div class="col-md-4">
                        <label class="form-label fw-bold">üèôÔ∏è Selecione a Cidade</label>
                        <select id="top-locations-city" class="form-select">
                            <option value="">Carregando...</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-bold">üìè Raio de Agrupamento (metros)</label>
                        <input type="number" id="top-locations-radius" class="form-control" value="50" min="10" max="500">
                        <small class="text-muted">Agrupa locais pr√≥ximos</small>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-bold">üìä Quantidade</label>
                        <select id="top-locations-limit" class="form-select">
                            <option value="5">Top 5</option>
                            <option value="10" selected>Top 10</option>
                            <option value="15">Top 15</option>
                            <option value="20">Top 20</option>
                        </select>
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button class="btn btn-warning w-100" type="button" onclick="TopLocationsManager.analyze()">
                            üîç Analisar
                        </button>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">üìÖ Selecione os Dias para An√°lise</label>
                    <div id="top-locations-dates" class="d-flex flex-wrap gap-2"></div>
                    <div class="mt-2">
                        <button class="btn btn-sm btn-outline-secondary" type="button" onclick="TopLocationsManager.selectAllDates()">‚úì Todos</button>
                        <button class="btn btn-sm btn-outline-secondary" type="button" onclick="TopLocationsManager.clearAllDates()">‚úó Nenhum</button>
                    </div>
                </div>

                <div id="top-locations-results" style="display: none;">
                    <hr>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0">üèÜ Ranking de Locais</h6>
                        <div>
                            <span class="badge bg-warning text-dark" id="top-locations-count">0 locais</span>
                            <button class="btn btn-sm btn-primary ms-2" type="button" onclick="TopLocationsManager.plotOnMap()">
                                üó∫Ô∏è Ver no Mapa
                            </button>
                            <button class="btn btn-sm btn-success ms-2" type="button" onclick="TopLocationsManager.exportResults()">
                                üì• Exportar CSV
                            </button>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead class="table-warning">
                                <tr>
                                    <th>üèÜ Pos</th>
                                    <th>üìç Coordenadas</th>
                                    <th>üìç Local / Bairro</th>
                                    <th>üî¢ Visitas</th>
                                    <th>‚è±Ô∏è Tempo Total</th>
                                    <th>‚è±Ô∏è Tempo M√©dio</th>
                                    <th>üìÖ √öltima Visita</th>
                                    <th>üó∫Ô∏è</th>
                                </tr>
                            </thead>
                            <tbody id="top-locations-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="resultArea" style="display: none;">
            <div class="card">
                <div class="card-header bg-white py-3 px-4 d-flex justify-content-between align-items-center">
                    <h5 id="displayDate" class="mb-0 fw-bold text-dark">Pr√©-visualiza√ß√£o</h5>
                    <span id="results-count" class="text-muted small"></span>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light text-uppercase text-secondary small">
                            <tr>
                                <th style="width: 50px;"></th>
                                <th class="ps-4">Status</th>
                                <th>In√≠cio</th>
                                <th>Fim</th>
                                <th>Dura√ß√£o</th>
                                <th>Dist√¢ncia</th>
                                <th>Local / Trajeto</th>
                                <th>Bairro</th>
                                <th class="text-center">Mapa</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Progress Overlay -->
    <div id="progress-overlay">
        <div class="progress-container">
            <div class="spinner-border text-primary mb-3"></div>
            <h5 id="progress-title">Processando...</h5>
            <div class="progress" style="height: 25px; width: 300px;">
                <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated"
                     role="progressbar" style="width: 0%">0%</div>
            </div>
            <p id="progress-details" class="text-muted small mt-2"></p>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" aria-live="polite" aria-atomic="true"></div>

    <script>
        'use strict';

        // ========================================
        // HELP MANAGER - Sistema de Ajuda
        // ========================================
        const HelpManager = {
            toggle() {
                const modalEl = document.getElementById('help-modal');
                if (!modalEl) {
                    this.createModal();
                }
                const modal = new bootstrap.Modal(document.getElementById('help-modal'));
                modal.show();
            },

            createModal() {
                const modal = document.createElement('div');
                modal.className = 'modal fade';
                modal.id = 'help-modal';
                modal.tabIndex = -1;
                modal.innerHTML = `
                    <div class="modal-dialog modal-lg modal-dialog-scrollable">
                        <div class="modal-content">
                            <div class="modal-header bg-primary text-white">
                                <h5 class="modal-title">‚ùì Ajuda - Analisador de Rotas V10.0</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <h6 class="fw-bold text-primary mb-3">‚å®Ô∏è Atalhos de Teclado</h6>
                                <table class="table table-sm table-hover">
                                    <tbody>
                                        <tr><td><kbd>‚Üê</kbd> <kbd>‚Üí</kbd></td><td>Navegar entre datas (ou pontos no tour)</td></tr>
                                        <tr><td><kbd>Ctrl</kbd> + <kbd>E</kbd></td><td>Exportar relat√≥rio (HTML)</td></tr>
                                        <tr><td><kbd>Ctrl</kbd> + <kbd>F</kbd></td><td>Focar na busca</td></tr>
                                        <tr><td><kbd>Ctrl</kbd> + <kbd>A</kbd></td><td>Selecionar todos os filtros de bairro</td></tr>
                                        <tr><td><kbd>Ctrl</kbd> + <kbd>D</kbd></td><td>Alternar modo escuro</td></tr>
                                        <tr><td><kbd>Ctrl</kbd> + <kbd>C</kbd></td><td>Comparar dois dias</td></tr>
                                        <tr><td><kbd>Ctrl</kbd> + <kbd>T</kbd></td><td>Iniciar/Parar tour no mapa</td></tr>
                                        <tr><td><kbd>Ctrl</kbd> + <kbd>L</kbd></td><td>Buscar por proximidade geogr√°fica</td></tr>
                                        <tr><td><kbd>Esc</kbd></td><td>Fechar detalhes ou parar tour</td></tr>
                                    </tbody>
                                </table>

                                <h6 class="fw-bold text-primary mb-3 mt-4">‚ú® Funcionalidades Principais</h6>
                                <ul class="small">
                                    <li><strong>Upload CSV/XLSX:</strong> Arraste ou selecione arquivos at√© 50MB</li>
                                    <li><strong>Parsing Robusto:</strong> Utiliza Papa Parse para CSV complexos</li>
                                    <li><strong>Filtros por Bairro:</strong> Filtre resultados com persist√™ncia autom√°tica (ocultos por padr√£o)</li>
                                    <li><strong>Busca Inteligente:</strong> Busque por endere√ßo, bairro ou hor√°rio</li>
                                    <li><strong>Estat√≠sticas Avan√ßadas:</strong> An√°lise de tempo, dist√¢ncia, velocidade e hor√°rios de pico</li>
                                    <li><strong>Mapa Interativo:</strong> Visualize rotas com Leaflet.js</li>
                                    <li><strong>Tour no Mapa:</strong> Navegue ponto a ponto com bot√µes ou teclas de seta</li>
                                    <li><strong>Busca por Proximidade:</strong> Encontre quantas vezes o ve√≠culo esteve em um local (raio configur√°vel)</li>
                                    <li><strong>Alertas Configur√°veis:</strong> Detecte paradas longas e velocidades excessivas</li>
                                    <li><strong>Calculadora de Custos:</strong> Estime combust√≠vel, m√£o de obra e manuten√ß√£o</li>
                                    <li><strong>Compara√ß√£o de Dias:</strong> Compare estat√≠sticas entre duas datas</li>
                                    <li><strong>Exporta√ß√µes M√∫ltiplas:</strong> HTML, CSV e JSON</li>
                                    <li><strong>Modo Escuro:</strong> Interface adapt√°vel com persist√™ncia</li>
                                    <li><strong>Hist√≥rico:</strong> √öltimos 10 arquivos processados salvos</li>
                                </ul>

                                <h6 class="fw-bold text-primary mb-3 mt-4">üîß Recursos T√©cnicos</h6>
                                <ul class="small">
                                    <li>‚úÖ Sem vulnerabilidades XSS (DOM API pura)</li>
                                    <li>‚úÖ Sem memory leaks (event delegation)</li>
                                    <li>‚úÖ Performance otimizada (debounce, pr√©-computa√ß√£o)</li>
                                    <li>‚úÖ Mobile responsivo (touch targets 44px)</li>
                                    <li>‚úÖ Testes inline (digite <code>window.runTests()</code> no console)</li>
                                    <li>‚úÖ Namespaces organizados (16 managers)</li>
                                </ul>

                                <h6 class="fw-bold text-primary mb-3 mt-4">üì¶ Managers Dispon√≠veis</h6>
                                <div class="row g-2 small">
                                    <div class="col-6 col-md-4"><span class="badge bg-secondary w-100">AppState</span></div>
                                    <div class="col-6 col-md-4"><span class="badge bg-secondary w-100">DataProcessor</span></div>
                                    <div class="col-6 col-md-4"><span class="badge bg-secondary w-100">UIRenderer</span></div>
                                    <div class="col-6 col-md-4"><span class="badge bg-secondary w-100">FilterManager</span></div>
                                    <div class="col-6 col-md-4"><span class="badge bg-secondary w-100">ExportManager</span></div>
                                    <div class="col-6 col-md-4"><span class="badge bg-secondary w-100">SearchManager</span></div>
                                    <div class="col-6 col-md-4"><span class="badge bg-secondary w-100">StatsManager</span></div>
                                    <div class="col-6 col-md-4"><span class="badge bg-secondary w-100">MapManager</span></div>
                                    <div class="col-6 col-md-4"><span class="badge bg-secondary w-100">MapTourManager</span></div>
                                    <div class="col-6 col-md-4"><span class="badge bg-secondary w-100">LocationSearchManager</span></div>
                                    <div class="col-6 col-md-4"><span class="badge bg-secondary w-100">AlertsManager</span></div>
                                    <div class="col-6 col-md-4"><span class="badge bg-secondary w-100">CostCalculator</span></div>
                                    <div class="col-6 col-md-4"><span class="badge bg-secondary w-100">ComparisonManager</span></div>
                                    <div class="col-6 col-md-4"><span class="badge bg-secondary w-100">StorageManager</span></div>
                                    <div class="col-6 col-md-4"><span class="badge bg-secondary w-100">TestRunner</span></div>
                                    <div class="col-6 col-md-4"><span class="badge bg-secondary w-100">HelpManager</span></div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <small class="text-muted me-auto">Vers√£o 10.0 - Desenvolvido com Claude Code</small>
                                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Fechar</button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
        };

        // ========================================
        // UTILIT√ÅRIOS GERAIS
        // ========================================
        const Utils = {
            debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            },

            throttle(func, limit) {
                let inThrottle;
                return function(...args) {
                    if (!inThrottle) {
                        func.apply(this, args);
                        inThrottle = true;
                        setTimeout(() => inThrottle = false, limit);
                    }
                };
            }
        };

        // ========================================
        // SECURITY UTILS - Sanitiza√ß√£o e Valida√ß√£o
        // ========================================
        const SecurityUtils = {
            sanitizeHTML(str) {
                if (!str) return '';
                return String(str)
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#039;');
            },

            isValidBrazilCoord(lat, lon) {
                return lat >= -33.75 && lat <= 5.27 && lon >= -73.99 && lon <= -34.79;
            }
        };

        // ========================================
        // APP STATE - Gerenciamento de Estado Global
        // ========================================
        const AppState = {
            data: {},
            currentDate: '',
            currentItinerary: [],

            filters: {
                allBairros: new Set(),
                selectedBairros: new Set(),
                bairroCounts: new Map()
            },

            stats: {
                total: 0,
                valid: 0,
                ignored: 0,
                invalidGPS: 0
            },

            setData(date, records) {
                this.data[date] = records;
            },

            getData(date) {
                return this.data[date] || [];
            },

            clearData() {
                this.data = {};
                this.filters.allBairros = new Set();
                this.filters.bairroCounts = new Map();
                this.stats = { total: 0, valid: 0, ignored: 0, invalidGPS: 0 };
            },

            getDates() {
                return Object.keys(this.data).sort();
            }
        };

        // ========================================
        // DATA PROCESSOR - Processamento de Dados
        // ========================================
        const DataProcessor = {
            IGNORED: ["Dispositivo Plug-In", "Sim Information", "Estou vivo!"],
            MERGE_THRESHOLD_MIN: 2.0,
            BRAKING_MERGE_THRESHOLD_MIN: 5.0,
            MAX_WAYPOINTS: 10,
            SPEED_BUMP_TRIGGERS: ["Frenagem brusca", "Freada excessiva", "Comportamento do motorista"],

            // Novos thresholds melhorados
            SPEED_THRESHOLD_KMH: 3.0,  // Velocidade m√≠nima para considerar em movimento (era 1.0)
            MIN_DISTANCE_METERS: 50,   // Dist√¢ncia m√≠nima para considerar deslocamento real
            MIN_STOP_DURATION_MIN: 3.0, // Dura√ß√£o m√≠nima para considerar parada v√°lida

            // Calcula dist√¢ncia entre dois pontos em metros (f√≥rmula de Haversine)
            calculateDistance(lat1, lon1, lat2, lon2) {
                const R = 6371000; // Raio da Terra em metros
                const dLat = (lat2 - lat1) * Math.PI / 180;
                const dLon = (lon2 - lon1) * Math.PI / 180;
                const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                          Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                          Math.sin(dLon / 2) * Math.sin(dLon / 2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                return R * c;
            },

            // Verifica se houve movimento real baseado em dist√¢ncia
            hasRealMovement(coords) {
                if (coords.length < 2) return false;

                let totalDistance = 0;
                for (let i = 1; i < coords.length; i++) {
                    const dist = this.calculateDistance(
                        coords[i-1].y, coords[i-1].x,
                        coords[i].y, coords[i].x
                    );
                    totalDistance += dist;
                }

                return totalDistance >= this.MIN_DISTANCE_METERS;
            },

            // Verifica se o ve√≠culo est√° realmente parado (velocidade baixa E sem movimento)
            isReallyStoppedSegment(segment) {
                if (!segment.coords || segment.coords.length < 2) {
                    return segment.type === 'Parada';
                }

                // Velocidade m√©dia baixa
                const avgSpeed = segment.coords.reduce((sum, c) => sum + (c.s || 0), 0) / segment.coords.length;
                const lowSpeed = avgSpeed < this.SPEED_THRESHOLD_KMH;

                // Sem movimento real
                const noMovement = !this.hasRealMovement(segment.coords);

                return lowSpeed && noMovement;
            },

            extractBairro(location) {
                if (!location) return 'Desconhecido';
                const parts = location.split(',').map(p => p.trim());
                if (parts.length >= 2) {
                    let bairro = parts[1];
                    bairro = bairro.replace(/^\d+\s*/, '').trim();
                    if (bairro.includes('Regi√£o') || bairro.includes('Microrregi√£o') || bairro.length < 3) {
                        if (parts.length >= 3) {
                            bairro = parts[2].replace(/^\d+\s*/, '').trim();
                        }
                    }
                    return bairro || 'Desconhecido';
                }
                return 'Desconhecido';
            },

            getSegmentBairros(item) {
                const bairros = new Set();
                if (item.locStart) bairros.add(this.extractBairro(item.locStart));
                if (item.locEnd) bairros.add(this.extractBairro(item.locEnd));
                return Array.from(bairros);
            },

            calcDuration(dateStr, startTime, endTime) {
                let d1 = new Date(`${dateStr} ${startTime}`);
                let d2 = new Date(`${dateStr} ${endTime}`);
                if (d2 < d1) d2.setDate(d2.getDate() + 1);
                return (d2 - d1) / 60000;
            },

            processRawData(rows, fileName) {
                AppState.clearData();
                let currentDateLocal = '';
                let firstDataRow = null;

                console.log(`üîÑ Processando ${rows.length} linhas do arquivo...`);

                rows.forEach((cols, index) => {
                    if (!cols || cols.length < 1) return;
                    let val0 = String(cols[0]).trim();
                    let event = cols[2] ? String(cols[2]) : "";

                    AppState.stats.total++;

                    if (this.IGNORED.some(ign => event.includes(ign))) {
                        AppState.stats.ignored++;
                        return;
                    }

                    if (/^\d{4}-\d{2}-\d{2}$/.test(val0)) {
                        currentDateLocal = val0;
                        if (!AppState.data[currentDateLocal]) {
                            AppState.data[currentDateLocal] = [];
                        }
                        console.log(`üìÖ Data encontrada: ${currentDateLocal}`);
                    } else if (/^\d{2}:\d{2}:\d{2}$/.test(val0) && currentDateLocal) {
                        let speed = parseFloat(cols[11]) || 0;
                        let lat = parseFloat(cols[16]);
                        let lon = parseFloat(cols[17]);
                        let location = cols[5] || '';

                        // Log primeira linha de dados v√°lida
                        if (!firstDataRow && index < 20) {
                            console.log(`üîç Linha ${index} - cols.length=${cols.length}:`, cols);
                            console.log(`   val0=${val0}, event=${event}, speed=${speed}, lat=${lat}, lon=${lon}, location=${location}`);
                        }

                        if (!isNaN(lat) && !isNaN(lon)) {
                            if (SecurityUtils.isValidBrazilCoord(lat, lon)) {
                                AppState.data[currentDateLocal].push({
                                    t: val0, l: location, e: event, s: speed,
                                    o: parseFloat(cols[14]) || 0, y: lat, x: lon
                                });

                                // Pr√©-computar bairros (OTIMIZA√á√ÉO - Item 4)
                                const bairro = this.extractBairro(location);
                                if (bairro !== 'Desconhecido') {
                                    AppState.filters.allBairros.add(bairro);
                                    AppState.filters.bairroCounts.set(
                                        bairro,
                                        (AppState.filters.bairroCounts.get(bairro) || 0) + 1
                                    );
                                }

                                AppState.stats.valid++;

                                if (!firstDataRow) {
                                    firstDataRow = true;
                                    console.log(`‚úÖ Primeiro registro v√°lido processado!`);
                                }
                            } else {
                                AppState.stats.invalidGPS++;
                                if (index < 10) {
                                    console.warn(`‚ö†Ô∏è GPS inv√°lido na linha ${index}: ${lat}, ${lon}`);
                                }
                            }
                        } else {
                            if (index < 10) {
                                console.warn(`‚ö†Ô∏è Coordenadas NaN na linha ${index}: cols[16]=${cols[16]}, cols[17]=${cols[17]}`);
                            }
                        }
                    }
                });

                console.log(`üìä Resultado: ${AppState.stats.valid} registros v√°lidos em ${Object.keys(AppState.data).length} dia(s)`);
                console.log(`üìä Stats: total=${AppState.stats.total}, ignored=${AppState.stats.ignored}, invalidGPS=${AppState.stats.invalidGPS}`);

                return {
                    success: Object.keys(AppState.data).length > 0,
                    numDates: Object.keys(AppState.data).length,
                    fileName: fileName
                };
            },

            calculateItinerary(raw, dateStr) {
                if (!raw || raw.length === 0) return [];
                let segments = [];
                let buffer = [raw[0]];

                // Fase 1: Agrupar pontos por velocidade (threshold melhorado)
                for (let i = 1; i < raw.length; i++) {
                    const prev = raw[i - 1];
                    const curr = raw[i];
                    const prevMove = prev.s > this.SPEED_THRESHOLD_KMH;
                    const currMove = curr.s > this.SPEED_THRESHOLD_KMH;

                    if (prevMove === currMove) {
                        buffer.push(curr);
                    } else {
                        segments.push(this.createSegment(buffer, dateStr));
                        buffer = [curr];
                    }
                }
                segments.push(this.createSegment(buffer, dateStr));

                // Fase 2: Corre√ß√µes baseadas em an√°lise de movimento real
                segments.forEach(s => {
                    // 2.1: Deslocamentos muito curtos (< 1 min) s√£o paradas
                    if (s.type === 'Deslocamento' && s.dur < 1.0) {
                        s.type = 'Parada';
                        s.km = 0;
                    }

                    // 2.2: Verificar movimento real por dist√¢ncia
                    if (s.type === 'Deslocamento') {
                        // Se marcado como deslocamento mas n√£o houve movimento real
                        if (!this.hasRealMovement(s.coords)) {
                            s.type = 'Parada';
                            s.km = 0;
                        }
                    }

                    // 2.3: Deslocamentos com 0 km e dura√ß√£o >= 2 min s√£o paradas
                    if (s.type === 'Deslocamento' && s.km === 0 && s.dur >= 2) {
                        s.type = 'Parada';
                    }
                });

                // Fase 3: Reclassificar paradas muito curtas
                for (let i = 0; i < segments.length; i++) {
                    let s = segments[i];
                    if (s.type === 'Parada') {
                        const hasBraking = s.events.some(evt =>
                            this.SPEED_BUMP_TRIGGERS.some(trig => evt.includes(trig))
                        );

                        // Paradas < 3 min (ou < 5 min com frenagem) s√£o deslocamentos
                        // EXCETO se realmente n√£o houve movimento
                        const isTooShort = s.dur < this.MIN_STOP_DURATION_MIN ||
                                          (hasBraking && s.dur < this.BRAKING_MERGE_THRESHOLD_MIN);

                        if (isTooShort && !this.isReallyStoppedSegment(s)) {
                            s.type = 'Deslocamento';
                        }
                    }
                }

                let merged = [];
                if (segments.length > 0) {
                    let cur = segments[0];
                    for (let i = 1; i < segments.length; i++) {
                        let nxt = segments[i];
                        if (cur.type === nxt.type) {
                            cur.end = nxt.end;
                            cur.endTime = nxt.endTime;
                            cur.dur += nxt.dur;
                            cur.km += nxt.km;
                            cur.locEnd = nxt.locEnd;
                            cur.coords = cur.coords.concat(nxt.coords);
                            cur.events = cur.events.concat(nxt.events);
                        } else {
                            merged.push(cur);
                            cur = nxt;
                        }
                    }
                    merged.push(cur);
                }

                // Filtro final: manter deslocamentos ou paradas > 3 min
                return merged.filter(s => s.type === 'Deslocamento' || s.dur > this.MIN_STOP_DURATION_MIN);
            },

            createSegment(list, dateStr) {
                const s = list[0], e = list[list.length - 1];
                const dur = this.calcDuration(dateStr, s.t, e.t);
                const d1 = new Date(`${dateStr} ${s.t}`);
                let d2 = new Date(`${dateStr} ${e.t}`);
                if (d2 < d1) d2.setDate(d2.getDate() + 1);

                return {
                    type: s.s > this.SPEED_THRESHOLD_KMH ? 'Deslocamento' : 'Parada',
                    start: s.t, end: e.t, startTime: d1, endTime: d2,
                    dur: dur, km: Math.max(0, e.o - s.o),
                    locStart: s.l, locEnd: e.l,
                    coords: list.map(r => ({ y: r.y, x: r.x, t: r.t, s: r.s, l: r.l })),
                    events: list.map(r => r.e).filter(x => x)
                };
            },

            getMapLink(item) {
                const c = item.coords;
                const origin = c[0];
                if (item.type === 'Parada') {
                    return `https://www.google.com/maps/search/?api=1&query=${origin.y},${origin.x}`;
                }

                const dest = c[c.length - 1];
                let wps = [];
                const mids = c.slice(1, -1);
                if (mids.length > 0) {
                    if (mids.length <= this.MAX_WAYPOINTS) {
                        wps = mids;
                    } else {
                        const step = mids.length / (this.MAX_WAYPOINTS + 1);
                        for (let i = 1; i <= this.MAX_WAYPOINTS; i++) {
                            wps.push(mids[Math.floor(i * step)]);
                        }
                    }
                }
                const wpStr = wps.map(p => `${p.y},${p.x}`).join('|');
                let url = `https://www.google.com/maps/dir/?api=1&origin=${origin.y},${origin.x}&destination=${dest.y},${dest.x}&travelmode=driving`;
                if (wpStr) url += `&waypoints=${wpStr}`;
                return url;
            }
        };

        // ========================================
        // PROGRESS MANAGER - Gerenciamento de Progresso
        // ========================================
        const ProgressManager = {
            show(title = 'Processando...') {
                document.getElementById('progress-overlay').style.display = 'flex';
                document.getElementById('progress-title').textContent = title;
                this.update(0);
            },

            hide() {
                document.getElementById('progress-overlay').style.display = 'none';
            },

            update(percent, details = '') {
                const bar = document.getElementById('progress-bar');
                bar.style.width = `${percent}%`;
                bar.textContent = `${Math.round(percent)}%`;

                if (details) {
                    document.getElementById('progress-details').textContent = details;
                }
            }
        };

        // ========================================
        // TOAST MANAGER - Sistema de Notifica√ß√µes
        // ========================================
        const ToastManager = {
            show(message, type = 'info', duration = 3000) {
                const container = document.getElementById('toast-container');

                const toastEl = document.createElement('div');
                toastEl.className = `toast toast-custom toast-${type}`;
                toastEl.setAttribute('role', 'alert');
                toastEl.innerHTML = `
                    <div class="toast-header">
                        <strong class="me-auto">${this.getIcon(type)} ${this.getTitle(type)}</strong>
                        <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
                    </div>
                    <div class="toast-body">${SecurityUtils.sanitizeHTML(message)}</div>
                `;

                container.appendChild(toastEl);

                const toast = new bootstrap.Toast(toastEl, { delay: duration });
                toast.show();

                toastEl.addEventListener('hidden.bs.toast', () => {
                    toastEl.remove();
                });
            },

            getIcon(type) {
                const icons = {
                    success: '‚úÖ',
                    error: '‚ùå',
                    warning: '‚ö†Ô∏è',
                    info: '‚ÑπÔ∏è'
                };
                return icons[type] || icons.info;
            },

            getTitle(type) {
                const titles = {
                    success: 'Sucesso',
                    error: 'Erro',
                    warning: 'Aten√ß√£o',
                    info: 'Informa√ß√£o'
                };
                return titles[type] || titles.info;
            },

            success(msg) { this.show(msg, 'success'); },
            error(msg) { this.show(msg, 'error', 5000); },
            warning(msg) { this.show(msg, 'warning', 4000); },
            info(msg) { this.show(msg, 'info'); }
        };

        // ========================================
        // THEME MANAGER - Gerenciamento de Tema
        // ========================================
        const ThemeManager = {
            STORAGE_KEY: 'theme-preference',

            init() {
                const savedTheme = localStorage.getItem(this.STORAGE_KEY) || 'light';
                this.apply(savedTheme);

                document.getElementById('theme-toggle').addEventListener('click', () => {
                    this.toggle();
                });
            },

            toggle() {
                const current = document.documentElement.getAttribute('data-theme') || 'light';
                const next = current === 'light' ? 'dark' : 'light';
                this.apply(next);
            },

            apply(theme) {
                document.documentElement.setAttribute('data-theme', theme);
                localStorage.setItem(this.STORAGE_KEY, theme);

                const icon = document.getElementById('theme-icon');
                icon.textContent = theme === 'light' ? 'üåô' : '‚òÄÔ∏è';
            }
        };

        // ========================================
        // FILTER MANAGER - Gerenciamento de Filtros
        // ========================================
        const FilterManager = {
            _applyDebounced: null,

            init() {
                // Event delegation para chips (elimina memory leaks - Item 2)
                const container = document.getElementById('bairros-container');
                container.addEventListener('click', (e) => {
                    const chip = e.target.closest('.bairro-chip');
                    if (chip) {
                        const bairro = chip.dataset.bairro;
                        this.toggle(bairro);
                    }
                });

                // Bot√µes de a√ß√£o
                document.getElementById('btn-select-all').addEventListener('click', () => this.selectAll());
                document.getElementById('btn-clear-all').addEventListener('click', () => this.clearAll());
                document.getElementById('btn-invert').addEventListener('click', () => this.invert());

                // Criar vers√£o debounced do apply (Item 5)
                this._applyDebounced = Utils.debounce(() => {
                    if (AppState.currentItinerary.length > 0 && AppState.currentDate) {
                        UIRenderer.renderTable(AppState.currentItinerary, AppState.currentDate);
                    }
                }, 150);
            },

            render() {
                const container = document.getElementById('bairros-container');
                container.innerHTML = '';

                // Usar bairroCounts pr√©-computado (Item 4 - j√° otimizado)
                const bairroCounts = AppState.filters.bairroCounts;

                // Ordenar bairros por contagem
                const sortedBairros = Array.from(AppState.filters.allBairros).sort((a, b) =>
                    (bairroCounts.get(b) || 0) - (bairroCounts.get(a) || 0)
                );

                // Usar DocumentFragment para melhor performance (Item 1)
                const fragment = document.createDocumentFragment();

                sortedBairros.forEach(bairro => {
                    const chip = document.createElement('span');
                    chip.className = `bairro-chip ${AppState.filters.selectedBairros.has(bairro) ? 'active' : ''}`;
                    chip.dataset.bairro = bairro; // Armazenar no dataset para event delegation

                    const bairroText = document.createTextNode(bairro);
                    chip.appendChild(bairroText);

                    const countSpan = document.createElement('span');
                    countSpan.className = 'count';
                    countSpan.textContent = bairroCounts.get(bairro) || 0;
                    chip.appendChild(countSpan);

                    fragment.appendChild(chip);
                });

                container.appendChild(fragment);
                this.updateStatus();
            },

            toggle(bairro) {
                if (AppState.filters.selectedBairros.has(bairro)) {
                    AppState.filters.selectedBairros.delete(bairro);
                } else {
                    AppState.filters.selectedBairros.add(bairro);
                }

                // Atualizar visualmente o chip
                const chip = document.querySelector(`[data-bairro="${CSS.escape(bairro)}"]`);
                if (chip) {
                    chip.classList.toggle('active');
                }

                this.updateStatus();
                StorageManager.saveFilters(); // Persistir filtros
                this._applyDebounced(); // Usar vers√£o debounced
            },

            selectAll() {
                AppState.filters.selectedBairros = new Set(AppState.filters.allBairros);
                document.querySelectorAll('.bairro-chip').forEach(c => c.classList.add('active'));
                this.updateStatus();
                this._applyDebounced();
            },

            clearAll() {
                AppState.filters.selectedBairros.clear();
                document.querySelectorAll('.bairro-chip').forEach(c => c.classList.remove('active'));
                this.updateStatus();
                this._applyDebounced();
            },

            invert() {
                const newSelected = new Set();
                AppState.filters.allBairros.forEach(b => {
                    if (!AppState.filters.selectedBairros.has(b)) newSelected.add(b);
                });
                AppState.filters.selectedBairros = newSelected;

                document.querySelectorAll('.bairro-chip').forEach(chip => {
                    const bairro = chip.dataset.bairro;
                    chip.classList.toggle('active', AppState.filters.selectedBairros.has(bairro));
                });

                this.updateStatus();
                this._applyDebounced();
            },

            updateStatus() {
                const status = document.getElementById('filter-status');
                status.textContent = `${AppState.filters.selectedBairros.size} de ${AppState.filters.allBairros.size} bairros selecionados`;
            },

            toggleBairros() {
                const container = document.getElementById('bairros-container');
                const actionsContainer = document.getElementById('filter-actions-container');
                const icon = document.getElementById('toggle-bairros-icon');
                const text = document.getElementById('toggle-bairros-text');

                // Verificar se est√° oculto usando getComputedStyle
                const computedStyle = window.getComputedStyle(container);
                const isHidden = computedStyle.display === 'none';

                if (isHidden) {
                    container.style.setProperty('display', 'flex', 'important');
                    actionsContainer.style.setProperty('display', 'flex', 'important');
                    icon.textContent = '‚ñ≤';
                    text.textContent = 'Ocultar';
                } else {
                    container.style.setProperty('display', 'none', 'important');
                    actionsContainer.style.setProperty('display', 'none', 'important');
                    icon.textContent = '‚ñº';
                    text.textContent = 'Mostrar';
                }
            },

            passes(item) {
                if (AppState.filters.selectedBairros.size === 0) return false;
                if (AppState.filters.selectedBairros.size === AppState.filters.allBairros.size) return true;

                const segmentBairros = DataProcessor.getSegmentBairros(item);
                return segmentBairros.some(b => AppState.filters.selectedBairros.has(b));
            }
        };

        // ========================================
        // UI RENDERER - Renderiza√ß√£o de Interface
        // ========================================
        const UIRenderer = {
            renderTable(data, dateDisplay) {
                document.getElementById('displayDate').innerText = `Data: ${dateDisplay.split('-').reverse().join('/')}`;
                document.getElementById('resultArea').style.display = 'block';

                // Mostrar se√ß√µes de busca e estat√≠sticas
                document.getElementById('search-section').style.display = 'block';

                const tbody = document.getElementById('tableBody');
                tbody.innerHTML = '';

                let visibleCount = 0;
                let totalCount = data.length;

                // Calcular e renderizar estat√≠sticas automaticamente
                const stats = StatsManager.calculate(data);
                if (stats) {
                    StatsManager.render(stats);
                }

                // Verificar alertas
                const alerts = AlertsManager.check(data);

                // Plotar no mapa automaticamente
                if (data.length > 0 && data.length <= 50) {
                    // Auto-plotar apenas se n√£o houver muitos segmentos
                    setTimeout(() => MapManager.plotItinerary(data), 500);
                }

                // Usar DocumentFragment para melhor performance (Item 1 - Corrige innerHTML +=)
                const fragment = document.createDocumentFragment();

                data.forEach((item, index) => {
                    const isVisible = FilterManager.passes(item);
                    if (!isVisible && AppState.filters.selectedBairros.size < AppState.filters.allBairros.size) {
                        return;
                    }
                    visibleCount++;

                    const isStop = item.type === 'Parada';
                    const badge = isStop ? 'badge-stop' : 'badge-move';
                    const mapLink = DataProcessor.getMapLink(item);
                    const clean = (t) => t ? SecurityUtils.sanitizeHTML(t.split(',').slice(0, 2).join(',')) : '---';

                    // Criar TR principal via DOM API
                    const tr = document.createElement('tr');

                    // Coluna 1: Bot√£o de detalhes
                    const tdDetails = document.createElement('td');
                    tdDetails.className = 'text-center align-middle';

                    let detailsRowElement = null;
                    if (!isStop && item.coords && item.coords.length > 0) {
                        const btn = document.createElement('button');
                        btn.className = 'btn btn-sm btn-outline-secondary';
                        btn.type = 'button';
                        btn.setAttribute('data-bs-toggle', 'collapse');
                        btn.setAttribute('data-bs-target', `#trip-details-${index}`);
                        btn.style.cssText = 'border-radius: 50%; width: 25px; height: 25px; padding: 0; line-height: 1; font-weight:bold;';
                        btn.textContent = '+';
                        tdDetails.appendChild(btn);

                        // Criar linha de detalhes
                        detailsRowElement = this.createDetailsRow(item, index);
                    }
                    tr.appendChild(tdDetails);

                    // Coluna 2: Status
                    const tdStatus = document.createElement('td');
                    tdStatus.className = 'ps-4 align-middle';
                    const badgeSpan = document.createElement('span');
                    badgeSpan.className = badge;
                    badgeSpan.textContent = item.type;
                    tdStatus.appendChild(badgeSpan);
                    tr.appendChild(tdStatus);

                    // Coluna 3: In√≠cio
                    const tdStart = document.createElement('td');
                    tdStart.className = 'align-middle';
                    tdStart.textContent = item.start;
                    tr.appendChild(tdStart);

                    // Coluna 4: Fim
                    const tdEnd = document.createElement('td');
                    tdEnd.className = 'align-middle';
                    tdEnd.textContent = item.end;
                    tr.appendChild(tdEnd);

                    // Coluna 5: Dura√ß√£o
                    const tdDur = document.createElement('td');
                    tdDur.className = 'align-middle';
                    tdDur.textContent = `${item.dur.toFixed(0)} min`;
                    tr.appendChild(tdDur);

                    // Coluna 6: Dist√¢ncia
                    const tdKm = document.createElement('td');
                    tdKm.className = 'align-middle';
                    tdKm.textContent = `${item.km.toFixed(1)} km`;
                    tr.appendChild(tdKm);

                    // Coluna 7: Local
                    const tdLoc = document.createElement('td');
                    tdLoc.className = 'align-middle';
                    if (isStop) {
                        const span = document.createElement('span');
                        span.className = 'text-muted';
                        span.innerHTML = clean(item.locStart);
                        tdLoc.appendChild(span);
                    } else {
                        const div = document.createElement('div');
                        div.style.fontSize = '0.9em';
                        div.innerHTML = `<strong class="text-success">‚ûú ${clean(item.locStart)}</strong><br><strong class="text-danger">üõë ${clean(item.locEnd)}</strong>`;
                        tdLoc.appendChild(div);
                    }
                    tr.appendChild(tdLoc);

                    // Coluna 8: Bairros
                    const tdBairro = document.createElement('td');
                    tdBairro.className = 'align-middle';
                    const segmentBairros = DataProcessor.getSegmentBairros(item);
                    segmentBairros.forEach(b => {
                        const bairroSpan = document.createElement('span');
                        bairroSpan.className = 'badge-bairro';
                        bairroSpan.textContent = b;
                        tdBairro.appendChild(bairroSpan);
                        tdBairro.appendChild(document.createTextNode(' '));
                    });
                    tr.appendChild(tdBairro);

                    // Coluna 9: Mapa
                    const tdMap = document.createElement('td');
                    tdMap.className = 'text-center align-middle';
                    const mapA = document.createElement('a');
                    mapA.href = mapLink;
                    mapA.target = '_blank';
                    mapA.className = 'btn-route';
                    mapA.textContent = isStop ? 'üìç Ver' : 'üöó Trajeto';
                    tdMap.appendChild(mapA);
                    tr.appendChild(tdMap);

                    fragment.appendChild(tr);

                    if (detailsRowElement) {
                        fragment.appendChild(detailsRowElement);
                    }
                });

                tbody.appendChild(fragment);

                // Atualizar contador de resultados
                const resultsCount = document.getElementById('results-count');
                if (AppState.filters.selectedBairros.size < AppState.filters.allBairros.size) {
                    resultsCount.textContent = `Exibindo ${visibleCount} de ${totalCount} segmentos (filtro ativo)`;
                    resultsCount.classList.add('text-primary');
                } else {
                    resultsCount.textContent = `${totalCount} segmentos`;
                    resultsCount.classList.remove('text-primary');
                }
            },

            createDetailsRow(item, index) {
                const tr = document.createElement('tr');
                tr.className = 'collapse';
                tr.id = `trip-details-${index}`;

                const td = document.createElement('td');
                td.colSpan = 9;
                td.className = 'p-3 bg-light';

                const card = document.createElement('div');
                card.className = 'card shadow-sm border-0 m-0';

                const cardHeader = document.createElement('div');
                cardHeader.className = 'card-header bg-white fw-bold text-primary small';
                cardHeader.textContent = `üìç Detalhamento do Trecho (${item.coords.length} pontos)`;
                card.appendChild(cardHeader);

                const cardBody = document.createElement('div');
                cardBody.className = 'card-body p-0';

                const tableWrapper = document.createElement('div');
                tableWrapper.className = 'table-responsive';
                tableWrapper.style.cssText = 'max-height: 250px; overflow-y: auto;';

                const table = document.createElement('table');
                table.className = 'table table-sm table-striped mb-0';

                const thead = document.createElement('thead');
                thead.className = 'sticky-top bg-white';
                thead.innerHTML = '<tr><th class="text-center">Hor√°rio</th><th class="text-center">Velocidade</th><th>Localiza√ß√£o</th><th>Bairro</th></tr>';
                table.appendChild(thead);

                const tbody = document.createElement('tbody');
                item.coords.forEach(point => {
                    const row = document.createElement('tr');

                    const tdTime = document.createElement('td');
                    tdTime.className = 'text-center small';
                    tdTime.textContent = point.t;
                    row.appendChild(tdTime);

                    const tdSpeed = document.createElement('td');
                    tdSpeed.className = 'text-center small';
                    tdSpeed.textContent = `${point.s} km/h`;
                    row.appendChild(tdSpeed);

                    const tdLoc = document.createElement('td');
                    tdLoc.className = 'small text-truncate';
                    tdLoc.style.maxWidth = '300px';
                    tdLoc.title = point.l;
                    tdLoc.textContent = point.l;
                    row.appendChild(tdLoc);

                    const tdBairro = document.createElement('td');
                    tdBairro.className = 'small';
                    const bairroSpan = document.createElement('span');
                    bairroSpan.className = 'badge-bairro';
                    bairroSpan.textContent = DataProcessor.extractBairro(point.l);
                    tdBairro.appendChild(bairroSpan);
                    row.appendChild(tdBairro);

                    tbody.appendChild(row);
                });
                table.appendChild(tbody);

                tableWrapper.appendChild(table);
                cardBody.appendChild(tableWrapper);
                card.appendChild(cardBody);
                td.appendChild(card);
                tr.appendChild(td);

                return tr;
            },

            renderDateButtons() {
                const nav = document.getElementById('date-navigation');
                nav.innerHTML = '';
                const dates = AppState.getDates();
                if (dates.length === 0) return;

                dates.forEach(date => {
                    const btn = document.createElement('button');
                    const [y, m, d] = date.split('-');
                    btn.className = 'btn btn-outline-primary btn-date';
                    btn.type = 'button';
                    btn.innerText = `${d}/${m}`;
                    btn.onclick = () => {
                        document.querySelectorAll('#date-navigation button').forEach(b => {
                            b.classList.remove('btn-primary', 'text-white');
                            b.classList.add('btn-outline-primary');
                        });
                        btn.classList.remove('btn-outline-primary');
                        btn.classList.add('btn-primary', 'text-white');
                        AppState.currentDate = date;
                        AppState.currentItinerary = DataProcessor.calculateItinerary(AppState.getData(date), date);
                        this.renderTable(AppState.currentItinerary, date);
                    };
                    nav.appendChild(btn);
                });
                nav.firstChild.click();
            },

            renderExportCheckboxes() {
                const container = document.getElementById('export-dates-container');
                container.innerHTML = '';

                const fragment = document.createDocumentFragment();
                AppState.getDates().forEach(date => {
                    const [y, m, d] = date.split('-');
                    const count = AppState.getData(date).length;

                    const div = document.createElement('div');
                    div.className = 'form-check form-check-inline';

                    const input = document.createElement('input');
                    input.className = 'form-check-input export-check';
                    input.type = 'checkbox';
                    input.id = `check-${date}`;
                    input.value = date;
                    input.checked = true;

                    const label = document.createElement('label');
                    label.className = 'form-check-label';
                    label.htmlFor = `check-${date}`;
                    label.innerHTML = `${d}/${m} <small class="text-muted">(${count})</small>`;

                    div.appendChild(input);
                    div.appendChild(label);
                    fragment.appendChild(div);
                });

                container.appendChild(fragment);
            },

            showSuccess(fileName) {
                const dropContent = document.getElementById('drop-content');
                dropContent.innerHTML = '';

                const successDiv = document.createElement('div');
                successDiv.className = 'success-box mb-0';
                successDiv.innerHTML = `<strong>‚úÖ Processado com sucesso!</strong><br><small>${SecurityUtils.sanitizeHTML(fileName)}</small>`;
                dropContent.appendChild(successDiv);

                const numDates = AppState.getDates().length;

                const statsArea = document.getElementById('stats-area');
                statsArea.style.display = 'block';
                statsArea.innerHTML = `
                    <div class="d-flex flex-wrap justify-content-center gap-2">
                        <span class="stats-badge">üìÖ ${numDates} dia(s)</span>
                        <span class="stats-badge">üìç ${AppState.stats.valid.toLocaleString()} registros</span>
                        <span class="stats-badge">üèòÔ∏è ${AppState.filters.allBairros.size} bairros</span>
                        ${AppState.stats.invalidGPS > 0 ? `<span class="stats-badge" style="background:#fef2f2;color:#991b1b;">‚ö†Ô∏è ${AppState.stats.invalidGPS} GPS inv√°lidos</span>` : ''}
                    </div>
                `;
            },

            showError(message) {
                const dropArea = document.getElementById('drop-area');
                const dropContent = document.getElementById('drop-content');

                dropArea.classList.remove('processing');
                dropContent.innerHTML = '';

                const errorDiv = document.createElement('div');
                errorDiv.className = 'error-box mb-0';
                errorDiv.innerHTML = `<strong>‚ùå Erro:</strong> ${SecurityUtils.sanitizeHTML(message)}`;
                dropContent.appendChild(errorDiv);

                const retry = document.createElement('p');
                retry.className = 'text-muted small mt-2 mb-0';
                retry.textContent = 'Clique para tentar novamente';
                dropContent.appendChild(retry);
            }
        };

        // ========================================
        // FILE HANDLER - Gerenciamento de Arquivos
        // ========================================
        const FileHandler = {
            MAX_FILE_SIZE: 50 * 1024 * 1024, // 50MB
            ALLOWED_EXTENSIONS: ['csv', 'xlsx', 'xls', 'pdf'],

            init() {
                const dropArea = document.getElementById('drop-area');
                const fileInput = document.getElementById('fileInput');

                dropArea.addEventListener('click', () => fileInput.click());
                fileInput.addEventListener('change', (e) => {
                    if (e.target.files[0]) this.handleFile(e.target.files[0]);
                });
                dropArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    dropArea.style.backgroundColor = '#eff6ff';
                });
                dropArea.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    dropArea.style.backgroundColor = '';
                });
                dropArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dropArea.style.backgroundColor = '';
                    if (e.dataTransfer.files[0]) this.handleFile(e.dataTransfer.files[0]);
                });
            },

            validate(file) {
                // Validar tamanho (Item 8)
                if (file.size > this.MAX_FILE_SIZE) {
                    return {
                        valid: false,
                        error: `Arquivo muito grande (${(file.size / 1024 / 1024).toFixed(1)}MB). M√°ximo permitido: ${this.MAX_FILE_SIZE / 1024 / 1024}MB`
                    };
                }

                // Validar extens√£o
                const ext = file.name.split('.').pop().toLowerCase();
                if (!this.ALLOWED_EXTENSIONS.includes(ext)) {
                    return {
                        valid: false,
                        error: `Formato inv√°lido. Aceito: ${this.ALLOWED_EXTENSIONS.join(', ')}`
                    };
                }

                // Validar nome (evitar path traversal)
                if (file.name.includes('..') || file.name.includes('/') || file.name.includes('\\')) {
                    return {
                        valid: false,
                        error: 'Nome de arquivo inv√°lido'
                    };
                }

                return { valid: true };
            },

            async processPDF(arrayBuffer) {
                try {
                    // Carregar PDF usando PDF.js
                    const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                    console.log(`üìÑ PDF carregado: ${pdf.numPages} p√°ginas`);

                    let allItems = [];

                    // Extrair texto estruturado de todas as p√°ginas preservando posi√ß√£o
                    for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                        const page = await pdf.getPage(pageNum);
                        const textContent = await page.getTextContent();

                        // Agrupar itens por linha (mesma posi√ß√£o Y)
                        const lineMap = new Map();

                        textContent.items.forEach(item => {
                            const y = Math.round(item.transform[5]); // Posi√ß√£o Y
                            if (!lineMap.has(y)) {
                                lineMap.set(y, []);
                            }
                            lineMap.get(y).push({
                                text: item.str,
                                x: item.transform[4],
                                y: y
                            });
                        });

                        // Ordenar linhas por Y (de cima para baixo)
                        const sortedLines = Array.from(lineMap.values())
                            .sort((a, b) => b[0].y - a[0].y);

                        // Ordenar itens dentro de cada linha por X (esquerda para direita)
                        sortedLines.forEach(line => {
                            line.sort((a, b) => a.x - b.x);
                        });

                        allItems.push(...sortedLines);
                    }

                    console.log(`üìä Total de linhas extra√≠das: ${allItems.length}`);

                    // Converter para formato de rows
                    const rows = [];

                    allItems.forEach(line => {
                        const rowText = line.map(item => item.text).join(' ');

                        // Dividir em colunas tentando diferentes estrat√©gias
                        let columns = [];

                        // Estrat√©gia 1: Espa√ßos m√∫ltiplos (2+)
                        columns = rowText.split(/\s{2,}/).map(c => c.trim()).filter(c => c);

                        // Estrat√©gia 2: Se n√£o funcionou, tentar por espa√ßo simples
                        if (columns.length < 10) {
                            columns = rowText.split(/\s+/).map(c => c.trim()).filter(c => c);
                        }

                        // Apenas adicionar linhas que parecem ter dados GPS
                        const hasDate = /\d{4}-\d{2}-\d{2}/.test(rowText);
                        const hasTime = /\d{2}:\d{2}:\d{2}/.test(rowText);
                        const hasCoords = /-?\d+\.\d{4,}/.test(rowText);

                        if (hasDate || (hasTime && hasCoords)) {
                            rows.push(columns);

                            // Log primeira linha de dados para debug
                            if (rows.length === 1 || (hasDate && rows.length < 5)) {
                                console.log('üìç Linha extra√≠da:', columns);
                            }
                        }
                    });

                    console.log(`‚úÖ Total de linhas de dados: ${rows.length}`);

                    if (rows.length === 0) {
                        throw new Error('Nenhum dado GPS encontrado no PDF');
                    }

                    // Tentar detectar estrutura de colunas
                    console.log('üîç Primeira linha:', rows[0]);
                    console.log('üîç Segunda linha:', rows[1]);

                    return rows;

                } catch (error) {
                    console.error('‚ùå Erro ao processar PDF:', error);
                    throw new Error(`N√£o foi poss√≠vel extrair dados do PDF: ${error.message}`);
                }
            },

            handleFile(file) {
                const validation = this.validate(file);
                if (!validation.valid) {
                    ToastManager.error(validation.error);
                    return;
                }

                const dropArea = document.getElementById('drop-area');
                const dropContent = document.getElementById('drop-content');

                dropArea.classList.add('processing');
                dropContent.innerHTML = `
                    <div class="d-flex align-items-center justify-content-center gap-3">
                        <div class="spinner-border text-warning" role="status"></div>
                        <div>
                            <h5 class="text-warning mb-1">Processando...</h5>
                            <p class="text-muted small mb-0">${SecurityUtils.sanitizeHTML(file.name)}</p>
                        </div>
                    </div>
                `;

                ProgressManager.show('Lendo arquivo...');

                const reader = new FileReader();
                const ext = file.name.split('.').pop().toLowerCase();

                reader.onprogress = (e) => {
                    if (e.lengthComputable) {
                        const percent = (e.loaded / e.total * 100);
                        ProgressManager.update(percent * 0.3, `Lendo: ${(e.loaded / 1024 / 1024).toFixed(1)}MB`);
                    }
                };

                reader.onload = async (e) => {
                    ProgressManager.update(30, 'Parseando dados...');

                    setTimeout(async () => {
                        try {
                            const data = e.target.result;
                            let rows = [];

                            if (ext === 'pdf') {
                                // Processar PDF
                                ProgressManager.update(40, 'Extraindo texto do PDF...');
                                rows = await this.processPDF(data);
                                ProgressManager.update(50, 'PDF parseado com sucesso');
                            } else if (ext === 'csv') {
                                const text = new TextDecoder().decode(data);
                                // Usar Papa Parse para CSV robusto (Item 3)
                                const parsed = Papa.parse(text, {
                                    skipEmptyLines: true,
                                    quotes: true,
                                    quoteChar: '"',
                                    escapeChar: '"',
                                    delimiter: ',',
                                    error: (error) => {
                                        console.error('Erro no parse CSV:', error);
                                    }
                                });
                                rows = parsed.data;
                                ProgressManager.update(50, 'CSV parseado com sucesso');
                            } else {
                                const wb = XLSX.read(data, { type: 'array' });
                                rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { header: 1 });
                                ProgressManager.update(50, 'XLSX parseado com sucesso');
                            }

                            ProgressManager.update(60, 'Processando registros...');
                            const result = DataProcessor.processRawData(rows, file.name);

                            dropArea.classList.remove('processing');

                            if (!result.success) {
                                ProgressManager.hide();
                                UIRenderer.showError('Nenhum dado v√°lido encontrado na planilha.');
                                ToastManager.error('Nenhum dado v√°lido encontrado');
                                return;
                            }

                            ProgressManager.update(95, 'Finalizando...');

                            UIRenderer.showSuccess(result.fileName);

                            // Inicializar filtros
                            AppState.filters.selectedBairros = new Set(AppState.filters.allBairros);
                            FilterManager.render();

                            document.getElementById('export-controls').style.display = 'block';
                            document.getElementById('filter-section').style.display = 'block';
                            UIRenderer.renderDateButtons();
                            UIRenderer.renderExportCheckboxes();

                            // Salvar no hist√≥rico
                            StorageManager.addToHistory(result.fileName, {
                                dates: result.numDates,
                                valid: AppState.stats.valid,
                                bairros: AppState.filters.allBairros.size
                            });

                            ProgressManager.update(100, 'Conclu√≠do!');
                            setTimeout(() => ProgressManager.hide(), 500);

                            ToastManager.success(`Arquivo processado: ${result.numDates} dia(s) encontrados`);

                        } catch (error) {
                            dropArea.classList.remove('processing');
                            ProgressManager.hide();
                            UIRenderer.showError(`Erro ao processar arquivo: ${error.message}`);
                            ToastManager.error(`Erro: ${error.message}`);
                        }
                    }, 100);
                };

                reader.onerror = () => {
                    dropArea.classList.remove('processing');
                    ProgressManager.hide();
                    UIRenderer.showError('Erro ao ler o arquivo.');
                    ToastManager.error('Erro ao ler o arquivo');
                };

                reader.readAsArrayBuffer(file);
            }
        };

        // ========================================
        // EXPORT MANAGER - Gerenciamento de Exporta√ß√µes
        // ========================================
        const ExportManager = {
            init() {
                document.getElementById('btn-select-all-export').addEventListener('click', () => {
                    document.querySelectorAll('.export-check').forEach(c => c.checked = true);
                });

                document.getElementById('btn-clear-all-export').addEventListener('click', () => {
                    document.querySelectorAll('.export-check').forEach(c => c.checked = false);
                });

                document.getElementById('export-html').addEventListener('click', (e) => {
                    e.preventDefault();
                    this.exportHTML();
                });

                document.getElementById('export-csv').addEventListener('click', (e) => {
                    e.preventDefault();
                    this.exportCSV();
                });

                document.getElementById('export-json').addEventListener('click', (e) => {
                    e.preventDefault();
                    this.exportJSON();
                });
            },

            getSelectedData() {
                const selectedDates = Array.from(document.querySelectorAll('.export-check:checked'))
                    .map(cb => cb.value);

                if (selectedDates.length === 0) {
                    ToastManager.warning("Selecione pelo menos um dia para exportar");
                    return null;
                }

                const data = {};
                selectedDates.forEach(date => {
                    if (AppState.data[date]) {
                        data[date] = AppState.data[date];
                    }
                });

                return { dates: selectedDates, data: data };
            },

            exportHTML() {
                const selected = this.getSelectedData();
                if (!selected) return;

                ToastManager.info('Gerando HTML...');

                // Implementa√ß√£o simplificada do export HTML
                // (A vers√£o completa est√° no arquivo original, pode ser portada depois)
                const htmlContent = `<!DOCTYPE html>
<html><head><title>Relat√≥rio V10.0</title></head>
<body><h1>Relat√≥rio exportado - ${selected.dates.length} dia(s)</h1>
<p>Export HTML completo ser√° implementado na pr√≥xima fase</p>
</body></html>`;

                const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `Relatorio_V10_${new Date().toISOString().split('T')[0]}.html`;
                a.click();
                URL.revokeObjectURL(a.href);

                ToastManager.success('HTML exportado com sucesso!');
            },

            exportCSV() {
                const selected = this.getSelectedData();
                if (!selected) return;

                ProgressManager.show('Gerando CSV...');

                setTimeout(() => {
                    const rows = [];

                    // Header
                    rows.push([
                        'Data',
                        'Tipo',
                        'In√≠cio',
                        'Fim',
                        'Dura√ß√£o (min)',
                        'Dist√¢ncia (km)',
                        'Local In√≠cio',
                        'Local Fim',
                        'Bairro In√≠cio',
                        'Bairro Fim'
                    ]);

                    // Dados
                    selected.dates.forEach(date => {
                        const itinerary = DataProcessor.calculateItinerary(selected.data[date], date);

                        itinerary.forEach(segment => {
                            const bairroStart = DataProcessor.extractBairro(segment.locStart);
                            const bairroEnd = DataProcessor.extractBairro(segment.locEnd);

                            rows.push([
                                date,
                                segment.type,
                                segment.start,
                                segment.end,
                                segment.dur.toFixed(2),
                                segment.km.toFixed(2),
                                (segment.locStart || '').replace(/,/g, ';'),
                                (segment.locEnd || '').replace(/,/g, ';'),
                                bairroStart,
                                bairroEnd
                            ]);
                        });
                    });

                    // Gerar CSV usando Papa Parse
                    const csv = Papa.unparse(rows, {
                        quotes: true,
                        delimiter: ',',
                        header: false
                    });

                    // Download com BOM UTF-8 para Excel
                    const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `Itinerario_${new Date().toISOString().split('T')[0]}.csv`;
                    a.click();
                    URL.revokeObjectURL(url);

                    ProgressManager.hide();
                    ToastManager.success('CSV exportado com sucesso!');
                }, 100);
            },

            exportJSON() {
                const selected = this.getSelectedData();
                if (!selected) return;

                const exportData = {
                    metadata: {
                        version: '10.0',
                        exportDate: new Date().toISOString(),
                        totalDays: selected.dates.length,
                        totalRecords: Object.values(selected.data).reduce((acc, d) => acc + d.length, 0)
                    },
                    filters: {
                        selectedBairros: Array.from(AppState.filters.selectedBairros)
                    },
                    data: {}
                };

                selected.dates.forEach(date => {
                    const rawData = selected.data[date];
                    const itinerary = DataProcessor.calculateItinerary(rawData, date);

                    exportData.data[date] = {
                        raw: rawData,
                        itinerary: itinerary
                    };
                });

                const json = JSON.stringify(exportData, null, 2);
                const blob = new Blob([json], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Itinerario_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);

                ToastManager.success('JSON exportado com sucesso!');
            }
        };

        // ========================================
        // KEYBOARD MANAGER - Atalhos de Teclado
        // ========================================
        const KeyboardManager = {
            init() {
                document.addEventListener('keydown', (e) => {
                    // Ignorar se estiver digitando em input/textarea
                    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                        return;
                    }

                    const key = e.key;
                    const ctrl = e.ctrlKey || e.metaKey;

                    // Navega√ß√£o entre datas (setas sem Ctrl) ou Tour no mapa
                    if (!ctrl && (key === 'ArrowLeft' || key === 'ArrowRight')) {
                        e.preventDefault();

                        // Se o tour estiver ativo, usar setas para navegar no tour
                        if (MapTourManager.isActive) {
                            if (key === 'ArrowLeft') {
                                MapTourManager.previous();
                            } else {
                                MapTourManager.next();
                            }
                        } else {
                            // Caso contr√°rio, navegar entre datas
                            this.handleNavigation(key === 'ArrowLeft' ? 'prev' : 'next');
                        }
                    }

                    // Atalhos com Ctrl
                    if (ctrl) {
                        switch(key.toLowerCase()) {
                            case 'e':
                                e.preventDefault();
                                document.getElementById('export-html')?.click();
                                break;
                            case 'f':
                                e.preventDefault();
                                document.getElementById('search-input')?.focus();
                                break;
                            case 'a':
                                e.preventDefault();
                                FilterManager.selectAll();
                                break;
                            case 'd':
                                e.preventDefault();
                                ThemeManager.toggle();
                                break;
                            case 'c':
                                e.preventDefault();
                                if (AppState.getDates().length >= 2) {
                                    ComparisonManager.show();
                                } else {
                                    ToastManager.info('√â necess√°rio ter pelo menos 2 datas para comparar');
                                }
                                break;
                            case 't':
                                e.preventDefault();
                                if (MapTourManager.isActive) {
                                    MapTourManager.stop();
                                } else if (AppState.currentItinerary && AppState.currentItinerary.length > 0) {
                                    MapTourManager.start();
                                } else {
                                    ToastManager.info('Carregue um itiner√°rio primeiro');
                                }
                                break;
                            case 'l':
                                e.preventDefault();
                                if (AppState.getDates().length > 0) {
                                    LocationSearchManager.show();
                                } else {
                                    ToastManager.info('Carregue dados primeiro');
                                }
                                break;
                        }
                    }

                    // Escape para fechar detalhes ou parar tour
                    if (key === 'Escape') {
                        // Se tour ativo, parar
                        if (MapTourManager.isActive) {
                            MapTourManager.stop();
                        } else {
                            document.querySelectorAll('.collapse.show').forEach(el => {
                                const bsCollapse = bootstrap.Collapse.getInstance(el);
                                bsCollapse?.hide();
                            });
                        }
                    }
                });
            },

            handleNavigation(direction) {
                const dates = AppState.getDates();
                const currentIndex = dates.indexOf(AppState.currentDate);

                if (direction === 'prev' && currentIndex > 0) {
                    const btn = document.querySelector(`#date-navigation button:nth-child(${currentIndex})`);
                    btn?.click();
                } else if (direction === 'next' && currentIndex < dates.length - 1) {
                    const btn = document.querySelector(`#date-navigation button:nth-child(${currentIndex + 2})`);
                    btn?.click();
                }
            }
        };

        // ========================================
        // STORAGE MANAGER - Persist√™ncia e Hist√≥rico
        // ========================================
        const StorageManager = {
            KEYS: {
                FILTERS: 'itinerary-filters',
                THEME: 'theme-preference',
                FILE_HISTORY: 'file-history',
                ALERTS_CONFIG: 'alerts-config',
                COST_CONFIG: 'cost-config'
            },

            MAX_HISTORY_ITEMS: 10,

            saveFilters() {
                const filters = {
                    selectedBairros: Array.from(AppState.filters.selectedBairros),
                    timestamp: Date.now()
                };

                try {
                    localStorage.setItem(this.KEYS.FILTERS, JSON.stringify(filters));
                } catch (e) {
                    console.warn('N√£o foi poss√≠vel salvar filtros:', e);
                }
            },

            loadFilters() {
                try {
                    const saved = localStorage.getItem(this.KEYS.FILTERS);
                    if (saved) {
                        const filters = JSON.parse(saved);
                        const age = Date.now() - filters.timestamp;
                        if (age < 7 * 24 * 60 * 60 * 1000) {
                            return new Set(filters.selectedBairros);
                        }
                    }
                } catch (e) {
                    console.warn('Erro ao carregar filtros:', e);
                }
                return null;
            },

            addToHistory(fileName, stats) {
                try {
                    let history = this.getHistory();
                    history.unshift({
                        fileName,
                        stats,
                        timestamp: Date.now()
                    });

                    if (history.length > this.MAX_HISTORY_ITEMS) {
                        history = history.slice(0, this.MAX_HISTORY_ITEMS);
                    }

                    localStorage.setItem(this.KEYS.FILE_HISTORY, JSON.stringify(history));
                } catch (e) {
                    console.warn('Erro ao salvar hist√≥rico:', e);
                }
            },

            getHistory() {
                try {
                    const saved = localStorage.getItem(this.KEYS.FILE_HISTORY);
                    return saved ? JSON.parse(saved) : [];
                } catch (e) {
                    return [];
                }
            }
        };

        // ========================================
        // SEARCH MANAGER - Busca com Debounce
        // ========================================
        const SearchManager = {
            currentTerm: '',
            matchedIndices: new Set(),

            init() {
                const input = document.getElementById('search-input');
                const clearBtn = document.getElementById('search-clear');

                const debouncedSearch = Utils.debounce((term) => {
                    this.search(term);
                }, 300);

                input.addEventListener('input', (e) => {
                    const term = e.target.value.trim();
                    this.currentTerm = term;

                    if (term.length > 0) {
                        clearBtn.style.display = 'block';
                        debouncedSearch(term);
                    } else {
                        clearBtn.style.display = 'none';
                        this.clear();
                    }
                });

                clearBtn.addEventListener('click', () => {
                    input.value = '';
                    clearBtn.style.display = 'none';
                    this.clear();
                });
            },

            search(term) {
                if (!AppState.currentItinerary || AppState.currentItinerary.length === 0) {
                    return;
                }

                const termLower = term.toLowerCase();
                this.matchedIndices.clear();

                AppState.currentItinerary.forEach((item, index) => {
                    const searchableText = [
                        item.locStart,
                        item.locEnd,
                        item.start,
                        item.end,
                        item.type,
                        ...DataProcessor.getSegmentBairros(item),
                        ...(item.coords?.map(c => c.l) || [])
                    ].join(' ').toLowerCase();

                    if (searchableText.includes(termLower)) {
                        this.matchedIndices.add(index);
                    }
                });

                this.highlightResults();
                this.showResultsCount();
            },

            highlightResults() {
                const tbody = document.getElementById('tableBody');
                const rows = tbody.querySelectorAll('tr:not(.collapse)');

                rows.forEach((row, index) => {
                    if (this.matchedIndices.has(index)) {
                        row.classList.add('search-highlight', 'table-warning');
                    } else {
                        row.classList.remove('search-highlight', 'table-warning');
                        if (this.currentTerm) {
                            row.style.opacity = '0.4';
                        } else {
                            row.style.opacity = '1';
                        }
                    }
                });

                if (this.matchedIndices.size > 0) {
                    const firstIndex = Math.min(...this.matchedIndices);
                    rows[firstIndex]?.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            },

            showResultsCount() {
                const resultsDiv = document.getElementById('search-results');

                if (this.matchedIndices.size > 0) {
                    resultsDiv.textContent = `${this.matchedIndices.size} resultado(s) encontrado(s)`;
                    resultsDiv.className = 'mt-2 small text-success';
                } else if (this.currentTerm) {
                    resultsDiv.textContent = 'Nenhum resultado encontrado';
                    resultsDiv.className = 'mt-2 small text-warning';
                } else {
                    resultsDiv.textContent = '';
                }
            },

            clear() {
                this.currentTerm = '';
                this.matchedIndices.clear();

                const tbody = document.getElementById('tableBody');
                tbody.querySelectorAll('tr:not(.collapse)').forEach(row => {
                    row.classList.remove('search-highlight', 'table-warning');
                    row.style.opacity = '1';
                });

                document.getElementById('search-results').textContent = '';
            }
        };

        // ========================================
        // STATS MANAGER - Estat√≠sticas Avan√ßadas
        // ========================================
        const StatsManager = {
            currentStats: null,

            calculate(itinerary) {
                if (!itinerary || itinerary.length === 0) return null;

                const movements = itinerary.filter(s => s.type === 'Deslocamento');
                const stops = itinerary.filter(s => s.type === 'Parada');

                const totalMovementTime = movements.reduce((acc, s) => acc + s.dur, 0);
                const totalStopTime = stops.reduce((acc, s) => acc + s.dur, 0);
                const totalDistance = movements.reduce((acc, s) => acc + s.km, 0);
                const totalMovementHours = totalMovementTime / 60;
                const avgSpeed = totalMovementHours > 0 ? totalDistance / totalMovementHours : 0;

                const bairroStats = this.calculateBairroStats(itinerary);
                const topBairros = Array.from(bairroStats.entries())
                    .sort((a, b) => b[1].count - a[1].count)
                    .slice(0, 5);

                const hourlyActivity = this.calculateHourlyActivity(itinerary);
                const peakHours = this.findPeakHours(hourlyActivity);

                return {
                    totalMovementTime,
                    totalStopTime,
                    totalDistance,
                    avgSpeed,
                    topBairros,
                    hourlyActivity,
                    peakHours,
                    movementCount: movements.length,
                    stopCount: stops.length
                };
            },

            calculateBairroStats(itinerary) {
                const stats = new Map();

                itinerary.forEach(segment => {
                    const bairros = DataProcessor.getSegmentBairros(segment);

                    bairros.forEach(bairro => {
                        if (!stats.has(bairro)) {
                            stats.set(bairro, { count: 0, totalTime: 0, totalDistance: 0 });
                        }

                        const stat = stats.get(bairro);
                        stat.count++;
                        stat.totalTime += segment.dur;
                        stat.totalDistance += segment.km || 0;
                    });
                });

                return stats;
            },

            calculateHourlyActivity(itinerary) {
                const hourly = Array(24).fill(0).map(() => ({ movements: 0, stops: 0, distance: 0 }));

                itinerary.forEach(segment => {
                    const hour = parseInt(segment.start.split(':')[0]);

                    if (segment.type === 'Deslocamento') {
                        hourly[hour].movements++;
                        hourly[hour].distance += segment.km;
                    } else {
                        hourly[hour].stops++;
                    }
                });

                return hourly;
            },

            findPeakHours(hourlyActivity) {
                const hours = hourlyActivity.map((data, hour) => ({
                    hour,
                    total: data.movements + data.stops,
                    ...data
                }));

                return hours.sort((a, b) => b.total - a.total).slice(0, 5);
            },

            render(stats) {
                if (!stats) return;

                this.currentStats = stats;
                document.getElementById('advanced-stats').style.display = 'block';

                document.getElementById('stat-movement-time').textContent = this.formatDuration(stats.totalMovementTime);
                document.getElementById('stat-stop-time').textContent = this.formatDuration(stats.totalStopTime);
                document.getElementById('stat-total-distance').textContent = `${stats.totalDistance.toFixed(1)} km`;
                document.getElementById('stat-avg-speed').textContent = `${stats.avgSpeed.toFixed(1)} km/h`;

                this.renderTopBairros(stats.topBairros);
                this.renderPeakHours(stats.peakHours);
            },

            renderTopBairros(topBairros) {
                const container = document.getElementById('top-bairros');
                container.innerHTML = '';

                topBairros.forEach(([bairro, data], index) => {
                    const item = document.createElement('div');
                    item.className = 'list-group-item d-flex justify-content-between align-items-center';
                    item.innerHTML = `
                        <div>
                            <strong>${index + 1}.</strong> ${SecurityUtils.sanitizeHTML(bairro)}
                            <br>
                            <small class="text-muted">
                                ${data.totalDistance.toFixed(1)} km | ${this.formatDuration(data.totalTime)}
                            </small>
                        </div>
                        <span class="badge bg-primary rounded-pill">${data.count}</span>
                    `;
                    container.appendChild(item);
                });
            },

            renderPeakHours(peakHours) {
                const container = document.getElementById('peak-hours');
                container.innerHTML = '';

                peakHours.forEach((data, index) => {
                    const item = document.createElement('div');
                    item.className = 'list-group-item d-flex justify-content-between align-items-center';
                    item.innerHTML = `
                        <div>
                            <strong>${String(data.hour).padStart(2, '0')}:00</strong>
                            <br>
                            <small class="text-muted">
                                ${data.movements} movimentos | ${data.stops} paradas
                            </small>
                        </div>
                        <span class="badge bg-secondary rounded-pill">${data.total}</span>
                    `;
                    container.appendChild(item);
                });
            },

            formatDuration(minutes) {
                const hours = Math.floor(minutes / 60);
                const mins = Math.round(minutes % 60);
                if (hours > 0) return `${hours}h ${mins}m`;
                return `${mins}m`;
            },

            refresh() {
                if (AppState.currentItinerary && AppState.currentItinerary.length > 0) {
                    const stats = this.calculate(AppState.currentItinerary);
                    this.render(stats);
                    AlertsManager.check(AppState.currentItinerary);
                    ToastManager.success('Estat√≠sticas atualizadas');
                }
            }
        };

        // ========================================
        // MAP MANAGER - Mapas Interativos
        // ========================================
        const MapManager = {
            map: null,
            markers: [],
            polylines: [],
            initialized: false,

            init() {
                if (this.initialized) return;

                this.map = L.map('map-container').setView([-15.7801, -47.9292], 4);

                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors',
                    maxZoom: 19
                }).addTo(this.map);

                this.initialized = true;
            },

            show() {
                document.getElementById('map-section').style.display = 'block';

                if (!this.initialized) {
                    this.init();
                }

                setTimeout(() => {
                    this.map.invalidateSize();
                }, 100);
            },

            toggle() {
                const section = document.getElementById('map-section');
                if (section.style.display === 'none') {
                    this.show();
                } else {
                    section.style.display = 'none';
                }
            },

            clear() {
                this.markers.forEach(marker => marker.remove());
                this.markers = [];
                this.polylines.forEach(polyline => polyline.remove());
                this.polylines = [];
            },

            plotItinerary(itinerary) {
                if (!this.initialized) this.init();

                this.clear();
                this.show();

                const bounds = [];

                itinerary.forEach((segment, index) => {
                    const coords = segment.coords;
                    if (!coords || coords.length === 0) return;

                    const isStop = segment.type === 'Parada';
                    const color = isStop ? '#ef4444' : '#3b82f6';

                    if (!isStop && coords.length > 1) {
                        const latLngs = coords.map(c => [c.y, c.x]);
                        const polyline = L.polyline(latLngs, {
                            color: color,
                            weight: 4,
                            opacity: 0.7
                        }).addTo(this.map);

                        polyline.bindPopup(this.createRoutePopup(segment, index));
                        this.polylines.push(polyline);
                        latLngs.forEach(ll => bounds.push(ll));
                    }

                    const startCoord = coords[0];
                    const startMarker = L.circleMarker([startCoord.y, startCoord.x], {
                        radius: isStop ? 8 : 6,
                        fillColor: color,
                        color: 'white',
                        weight: 2,
                        opacity: 1,
                        fillOpacity: 0.9
                    }).addTo(this.map);

                    startMarker.bindPopup(this.createMarkerPopup(segment, 'in√≠cio', index));
                    this.markers.push(startMarker);
                    bounds.push([startCoord.y, startCoord.x]);
                });

                if (bounds.length > 0) {
                    this.map.fitBounds(bounds, { padding: [50, 50] });
                }

                ToastManager.info(`${itinerary.length} segmentos plotados no mapa`);
            },

            createMarkerPopup(segment, type, index) {
                const bairro = type === 'in√≠cio'
                    ? DataProcessor.extractBairro(segment.locStart)
                    : DataProcessor.extractBairro(segment.locEnd);

                const location = type === 'in√≠cio' ? segment.locStart : segment.locEnd;
                const time = type === 'in√≠cio' ? segment.start : segment.end;

                return `
                    <div style="min-width: 200px;">
                        <strong>${segment.type} ${type === 'in√≠cio' ? '‚ñ∂Ô∏è' : 'üèÅ'}</strong><br>
                        <small class="text-muted">#${index + 1}</small><br><br>
                        <strong>Hor√°rio:</strong> ${time}<br>
                        <strong>Bairro:</strong> ${SecurityUtils.sanitizeHTML(bairro)}<br>
                        <strong>Local:</strong> ${SecurityUtils.sanitizeHTML(location?.split(',').slice(0, 2).join(','))}<br>
                        ${segment.type === 'Parada' ? `<strong>Dura√ß√£o:</strong> ${segment.dur.toFixed(0)} min` : ''}
                    </div>
                `;
            },

            createRoutePopup(segment, index) {
                return `
                    <div style="min-width: 200px;">
                        <strong>üöó ${segment.type}</strong><br>
                        <small class="text-muted">#${index + 1}</small><br><br>
                        <strong>In√≠cio:</strong> ${segment.start}<br>
                        <strong>Fim:</strong> ${segment.end}<br>
                        <strong>Dura√ß√£o:</strong> ${segment.dur.toFixed(0)} min<br>
                        <strong>Dist√¢ncia:</strong> ${segment.km.toFixed(1)} km<br>
                        <strong>Pontos:</strong> ${segment.coords.length}
                    </div>
                `;
            },

            fitBounds() {
                if (this.polylines.length > 0 || this.markers.length > 0) {
                    const bounds = [];
                    this.polylines.forEach(p => p.getLatLngs().forEach(ll => bounds.push(ll)));
                    this.markers.forEach(m => bounds.push(m.getLatLng()));
                    if (bounds.length > 0) {
                        this.map.fitBounds(bounds, { padding: [50, 50] });
                    }
                }
            }
        };

        // ========================================
        // MAP TOUR MANAGER - Tour Interativo no Mapa
        // ========================================
        const MapTourManager = {
            currentIndex: 0,
            itinerary: [],
            isActive: false,
            currentMarker: null,

            start() {
                if (!AppState.currentItinerary || AppState.currentItinerary.length === 0) {
                    ToastManager.warning('Nenhum itiner√°rio carregado para o tour');
                    return;
                }

                this.itinerary = AppState.currentItinerary.filter(segment =>
                    segment.coords && segment.coords.length > 0
                );

                if (this.itinerary.length === 0) {
                    ToastManager.warning('Nenhum ponto com coordenadas v√°lidas');
                    return;
                }

                this.currentIndex = 0;
                this.isActive = true;

                // Inicializar mapa se necess√°rio
                if (!MapManager.initialized) {
                    MapManager.init();
                }
                MapManager.show();

                // Mostrar controles e ocultar bot√£o de iniciar
                document.getElementById('tour-start-btn').style.display = 'none';
                document.getElementById('tour-controls').style.display = 'inline-block';
                document.getElementById('tour-info-box').style.display = 'block';

                this.showPoint(0);
                ToastManager.success('Tour iniciado! Use os bot√µes para navegar');
            },

            stop() {
                this.isActive = false;
                this.currentIndex = 0;

                // Restaurar visualiza√ß√£o normal
                document.getElementById('tour-start-btn').style.display = 'inline-block';
                document.getElementById('tour-controls').style.display = 'none';
                document.getElementById('tour-info-box').style.display = 'none';

                // Remover marker destacado
                if (this.currentMarker) {
                    this.currentMarker.remove();
                    this.currentMarker = null;
                }

                // Mostrar itiner√°rio completo novamente
                MapManager.plotItinerary(AppState.currentItinerary);
                ToastManager.info('Tour finalizado');
            },

            next() {
                if (!this.isActive) return;

                if (this.currentIndex < this.itinerary.length - 1) {
                    this.currentIndex++;
                    this.showPoint(this.currentIndex);
                } else {
                    ToastManager.info('Voc√™ chegou ao final do itiner√°rio');
                }
            },

            previous() {
                if (!this.isActive) return;

                if (this.currentIndex > 0) {
                    this.currentIndex--;
                    this.showPoint(this.currentIndex);
                } else {
                    ToastManager.info('Voc√™ est√° no in√≠cio do itiner√°rio');
                }
            },

            showPoint(index) {
                const segment = this.itinerary[index];
                if (!segment || !segment.coords || segment.coords.length === 0) return;

                // Atualizar contador
                document.getElementById('tour-counter').textContent = `${index + 1}/${this.itinerary.length}`;

                // Atualizar bot√µes
                document.getElementById('tour-prev-btn').disabled = index === 0;
                document.getElementById('tour-next-btn').disabled = index === this.itinerary.length - 1;

                // Pegar coordenada principal (in√≠cio do segmento)
                const coord = segment.coords[0];
                const latLng = [coord.y, coord.x];

                // Remover marker anterior
                if (this.currentMarker) {
                    this.currentMarker.remove();
                }

                // Criar marker destacado para o ponto atual
                const isStop = segment.type === 'Parada';
                const color = isStop ? '#ef4444' : '#3b82f6';

                this.currentMarker = L.circleMarker(latLng, {
                    radius: 15,
                    fillColor: color,
                    color: '#fff',
                    weight: 3,
                    opacity: 1,
                    fillOpacity: 0.8
                }).addTo(MapManager.map);

                // Adicionar anima√ß√£o pulsante
                this.currentMarker.bindPopup(this.createTourPopup(segment, index), {
                    autoClose: false
                }).openPopup();

                // Centralizar mapa no ponto
                MapManager.map.setView(latLng, 16, {
                    animate: true,
                    duration: 0.5
                });

                // Atualizar info box
                this.updateInfoBox(segment, index);
            },

            createTourPopup(segment, index) {
                const isStop = segment.type === 'Parada';
                const bairro = DataProcessor.extractBairro(segment.locStart);

                return `
                    <div style="min-width: 250px;">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <strong style="font-size: 1.1em;">${segment.type} ${isStop ? 'üõë' : 'üöó'}</strong>
                            <span class="badge bg-primary">#${index + 1}</span>
                        </div>
                        <hr style="margin: 8px 0;">
                        <div style="line-height: 1.6;">
                            <strong>‚è∞ In√≠cio:</strong> ${segment.start}<br>
                            <strong>üèÅ Fim:</strong> ${segment.end}<br>
                            <strong>‚è±Ô∏è Dura√ß√£o:</strong> ${segment.dur.toFixed(0)} minutos<br>
                            ${!isStop ? `<strong>üìè Dist√¢ncia:</strong> ${segment.km.toFixed(1)} km<br>` : ''}
                            <strong>üèòÔ∏è Bairro:</strong> ${SecurityUtils.sanitizeHTML(bairro)}<br>
                            <strong>üìç Local:</strong> <small>${SecurityUtils.sanitizeHTML(segment.locStart?.substring(0, 50))}...</small>
                        </div>
                    </div>
                `;
            },

            updateInfoBox(segment, index) {
                const isStop = segment.type === 'Parada';
                const bairro = DataProcessor.extractBairro(segment.locStart);

                document.getElementById('tour-point-title').textContent =
                    `Ponto ${index + 1} de ${this.itinerary.length}`;

                document.getElementById('tour-point-type').textContent = segment.type;
                document.getElementById('tour-point-type').className =
                    `badge ${isStop ? 'bg-danger' : 'bg-primary'}`;

                document.getElementById('tour-point-details').innerHTML = `
                    <div class="row g-2">
                        <div class="col-6"><strong>‚è∞ In√≠cio:</strong> ${segment.start}</div>
                        <div class="col-6"><strong>üèÅ Fim:</strong> ${segment.end}</div>
                        <div class="col-6"><strong>‚è±Ô∏è Dura√ß√£o:</strong> ${segment.dur.toFixed(0)} min</div>
                        ${!isStop ? `<div class="col-6"><strong>üìè Dist√¢ncia:</strong> ${segment.km.toFixed(1)} km</div>` : '<div class="col-6"></div>'}
                        <div class="col-12"><strong>üèòÔ∏è Bairro:</strong> ${SecurityUtils.sanitizeHTML(bairro)}</div>
                        <div class="col-12"><strong>üìç Local:</strong> <small>${SecurityUtils.sanitizeHTML(segment.locStart?.substring(0, 80))}</small></div>
                    </div>
                `;
            }
        };

        // ========================================
        // ALERTS MANAGER - Alertas Configur√°veis
        // ========================================
        const AlertsManager = {
            config: {
                longStopMinutes: 30,
                excessiveSpeedKmh: 80
            },
            alerts: [],

            init() {
                const saved = localStorage.getItem('alerts-config');
                if (saved) {
                    this.config = { ...this.config, ...JSON.parse(saved) };
                }
            },

            check(itinerary) {
                this.alerts = [];

                itinerary.forEach((segment, index) => {
                    if (segment.type === 'Parada' && segment.dur > this.config.longStopMinutes) {
                        this.alerts.push({
                            type: 'long_stop',
                            severity: 'warning',
                            segment: index,
                            message: `Parada longa detectada: ${segment.dur.toFixed(0)} minutos`,
                            details: `Local: ${segment.locStart}`
                        });
                    }

                    if (segment.type === 'Deslocamento' && segment.coords) {
                        const maxSpeed = Math.max(...segment.coords.map(c => c.s));
                        if (maxSpeed > this.config.excessiveSpeedKmh) {
                            this.alerts.push({
                                type: 'excessive_speed',
                                severity: 'danger',
                                segment: index,
                                message: `Velocidade excessiva: ${maxSpeed.toFixed(0)} km/h`,
                                details: `Limite configurado: ${this.config.excessiveSpeedKmh} km/h`
                            });
                        }
                    }

                    if (segment.type === 'Deslocamento' && segment.km === 0) {
                        this.alerts.push({
                            type: 'zero_distance',
                            severity: 'info',
                            segment: index,
                            message: 'Deslocamento sem dist√¢ncia registrada',
                            details: 'Poss√≠vel erro de od√¥metro ou GPS'
                        });
                    }
                });

                return this.alerts;
            },

            show() {
                if (this.alerts.length === 0) {
                    ToastManager.info('Nenhum alerta detectado');
                    return;
                }

                const alertsHtml = this.alerts.map(alert => `
                    <div class="alert alert-${this.getSeverityClass(alert.severity)} mb-2">
                        <strong>${this.getTypeIcon(alert.type)} Segmento #${alert.segment + 1}:</strong> ${alert.message}
                        <br><small class="text-muted">${alert.details}</small>
                    </div>
                `).join('');

                const modal = document.createElement('div');
                modal.className = 'modal fade';
                modal.innerHTML = `
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header bg-warning text-dark">
                                <h5 class="modal-title">‚ö†Ô∏è Alertas Detectados (${this.alerts.length})</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">${alertsHtml}</div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                            </div>
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);
                const bsModal = new bootstrap.Modal(modal);
                bsModal.show();

                modal.addEventListener('hidden.bs.modal', () => modal.remove());
            },

            getSeverityClass(severity) {
                const map = { danger: 'danger', warning: 'warning', info: 'info' };
                return map[severity] || 'secondary';
            },

            getTypeIcon(type) {
                const icons = { long_stop: '‚è±Ô∏è', excessive_speed: '‚ö°', zero_distance: '‚ùì' };
                return icons[type] || '‚ö†Ô∏è';
            }
        };

        // ========================================
        // COST CALCULATOR - Calculadora de Custos
        // ========================================
        const CostCalculator = {
            config: {
                fuelPricePerLiter: 5.50,
                vehicleConsumption: 10.0,
                hourlyWageCost: 25.00,
                maintenanceCostPerKm: 0.15
            },

            init() {
                const saved = localStorage.getItem('cost-config');
                if (saved) {
                    this.config = { ...this.config, ...JSON.parse(saved) };
                }
            },

            calculate(itinerary) {
                const movements = itinerary.filter(s => s.type === 'Deslocamento');
                const totalKm = movements.reduce((acc, s) => acc + s.km, 0);
                const totalMinutes = itinerary.reduce((acc, s) => acc + s.dur, 0);
                const totalHours = totalMinutes / 60;

                const fuelCost = (totalKm / this.config.vehicleConsumption) * this.config.fuelPricePerLiter;
                const laborCost = totalHours * this.config.hourlyWageCost;
                const maintenanceCost = totalKm * this.config.maintenanceCostPerKm;
                const totalCost = fuelCost + laborCost + maintenanceCost;

                return { totalKm, totalHours, fuelCost, laborCost, maintenanceCost, totalCost, costPerKm: totalKm > 0 ? totalCost / totalKm : 0 };
            },

            show() {
                if (!AppState.currentItinerary || AppState.currentItinerary.length === 0) {
                    ToastManager.warning('Nenhum dado para calcular custos');
                    return;
                }

                const costs = this.calculate(AppState.currentItinerary);

                const modal = document.createElement('div');
                modal.className = 'modal fade';
                modal.innerHTML = `
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header bg-success text-white">
                                <h5 class="modal-title">üí∞ C√°lculo de Custos</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="alert alert-info">
                                    <strong>Resumo da Opera√ß√£o</strong><br>
                                    Dist√¢ncia: ${costs.totalKm.toFixed(1)} km<br>
                                    Tempo: ${costs.totalHours.toFixed(1)} horas
                                </div>
                                <table class="table table-borderless">
                                    <tbody>
                                        <tr>
                                            <td><strong>‚õΩ Combust√≠vel</strong></td>
                                            <td class="text-end">R$ ${costs.fuelCost.toFixed(2)}</td>
                                        </tr>
                                        <tr>
                                            <td class="small text-muted ps-4">
                                                ${(costs.totalKm / this.config.vehicleConsumption).toFixed(1)} L √ó R$ ${this.config.fuelPricePerLiter.toFixed(2)}
                                            </td>
                                            <td></td>
                                        </tr>
                                        <tr>
                                            <td><strong>üë∑ M√£o de Obra</strong></td>
                                            <td class="text-end">R$ ${costs.laborCost.toFixed(2)}</td>
                                        </tr>
                                        <tr>
                                            <td class="small text-muted ps-4">
                                                ${costs.totalHours.toFixed(1)} h √ó R$ ${this.config.hourlyWageCost.toFixed(2)}
                                            </td>
                                            <td></td>
                                        </tr>
                                        <tr>
                                            <td><strong>üîß Manuten√ß√£o</strong></td>
                                            <td class="text-end">R$ ${costs.maintenanceCost.toFixed(2)}</td>
                                        </tr>
                                        <tr>
                                            <td class="small text-muted ps-4">
                                                ${costs.totalKm.toFixed(1)} km √ó R$ ${this.config.maintenanceCostPerKm.toFixed(2)}
                                            </td>
                                            <td></td>
                                        </tr>
                                        <tr class="border-top">
                                            <td><strong>üíµ TOTAL</strong></td>
                                            <td class="text-end"><strong class="text-success fs-5">R$ ${costs.totalCost.toFixed(2)}</strong></td>
                                        </tr>
                                        <tr>
                                            <td colspan="2" class="text-center small text-muted">
                                                Custo por km: R$ ${costs.costPerKm.toFixed(2)}
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                            </div>
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);
                const bsModal = new bootstrap.Modal(modal);
                bsModal.show();

                modal.addEventListener('hidden.bs.modal', () => modal.remove());
            }
        };

        // ========================================
        // COMPARISON MANAGER - Compara√ß√£o Entre Dias
        // ========================================
        const ComparisonManager = {
            init() {
                const dates = AppState.getDates();
                if (dates.length >= 2) {
                    const selectA = document.getElementById('compare-date-a');
                    const selectB = document.getElementById('compare-date-b');

                    selectA.innerHTML = dates.map(d => `<option value="${d}">${d}</option>`).join('');
                    selectB.innerHTML = dates.map(d => `<option value="${d}">${d}</option>`).join('');

                    if (dates.length >= 2) {
                        selectA.value = dates[0];
                        selectB.value = dates[1];
                    }
                }
            },

            show() {
                this.init();
                document.getElementById('comparison-section').style.display = 'block';
                document.getElementById('comparison-section').scrollIntoView({ behavior: 'smooth' });
            },

            hide() {
                document.getElementById('comparison-section').style.display = 'none';
            },

            compare() {
                const dateA = document.getElementById('compare-date-a').value;
                const dateB = document.getElementById('compare-date-b').value;

                if (!dateA || !dateB) {
                    ToastManager.warning('Selecione duas datas para comparar');
                    return;
                }

                if (dateA === dateB) {
                    ToastManager.warning('Selecione duas datas diferentes');
                    return;
                }

                const dataA = AppState.getData(dateA);
                const dataB = AppState.getData(dateB);

                if (!dataA || !dataB) {
                    ToastManager.error('Dados n√£o encontrados para as datas selecionadas');
                    return;
                }

                const itineraryA = DataProcessor.calculateItinerary(dataA, dateA);
                const itineraryB = DataProcessor.calculateItinerary(dataB, dateB);

                this.renderComparison(dateA, dateB, itineraryA, itineraryB);
            },

            renderComparison(dateA, dateB, itineraryA, itineraryB) {
                const statsA = StatsManager.calculate(itineraryA);
                const statsB = StatsManager.calculate(itineraryB);

                const container = document.getElementById('comparison-results');

                // Calcular diferen√ßas
                const diffDistance = statsB.totalDistance - statsA.totalDistance;
                const diffMovementTime = statsB.totalMovementTime - statsA.totalMovementTime;
                const diffStopTime = statsB.totalStopTime - statsA.totalStopTime;
                const diffAvgSpeed = statsB.avgSpeed - statsA.avgSpeed;

                const formatDiff = (value, unit) => {
                    if (value > 0) return `<span class="text-success">+${value.toFixed(1)} ${unit}</span>`;
                    if (value < 0) return `<span class="text-danger">${value.toFixed(1)} ${unit}</span>`;
                    return `<span class="text-muted">= ${unit}</span>`;
                };

                const formatTimeDiff = (minutes) => {
                    const absMinutes = Math.abs(minutes);
                    const h = Math.floor(absMinutes / 60);
                    const m = absMinutes % 60;
                    const formatted = h > 0 ? `${h}h ${m}min` : `${m}min`;
                    if (minutes > 0) return `<span class="text-success">+${formatted}</span>`;
                    if (minutes < 0) return `<span class="text-danger">-${formatted}</span>`;
                    return `<span class="text-muted">=</span>`;
                };

                container.innerHTML = `
                    <div class="row g-3 mb-4">
                        <div class="col-md-3">
                            <div class="card h-100">
                                <div class="card-body text-center">
                                    <div class="h5 mb-2">üèÅ Dist√¢ncia</div>
                                    <div class="fs-5 fw-bold">${statsA.totalDistance.toFixed(1)} km</div>
                                    <div class="text-muted small">vs</div>
                                    <div class="fs-5 fw-bold">${statsB.totalDistance.toFixed(1)} km</div>
                                    <div class="mt-2">${formatDiff(diffDistance, 'km')}</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card h-100">
                                <div class="card-body text-center">
                                    <div class="h5 mb-2">‚è±Ô∏è Movimento</div>
                                    <div class="fs-6">${Math.floor(statsA.totalMovementTime / 60)}h ${statsA.totalMovementTime % 60}min</div>
                                    <div class="text-muted small">vs</div>
                                    <div class="fs-6">${Math.floor(statsB.totalMovementTime / 60)}h ${statsB.totalMovementTime % 60}min</div>
                                    <div class="mt-2">${formatTimeDiff(diffMovementTime)}</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card h-100">
                                <div class="card-body text-center">
                                    <div class="h5 mb-2">üõë Paradas</div>
                                    <div class="fs-6">${Math.floor(statsA.totalStopTime / 60)}h ${statsA.totalStopTime % 60}min</div>
                                    <div class="text-muted small">vs</div>
                                    <div class="fs-6">${Math.floor(statsB.totalStopTime / 60)}h ${statsB.totalStopTime % 60}min</div>
                                    <div class="mt-2">${formatTimeDiff(diffStopTime)}</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card h-100">
                                <div class="card-body text-center">
                                    <div class="h5 mb-2">‚ö° Vel. M√©dia</div>
                                    <div class="fs-5 fw-bold">${statsA.avgSpeed.toFixed(1)} km/h</div>
                                    <div class="text-muted small">vs</div>
                                    <div class="fs-5 fw-bold">${statsB.avgSpeed.toFixed(1)} km/h</div>
                                    <div class="mt-2">${formatDiff(diffAvgSpeed, 'km/h')}</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-primary text-white">
                                    <h6 class="mb-0">üìÖ ${dateA}</h6>
                                </div>
                                <div class="card-body">
                                    <ul class="list-unstyled mb-0">
                                        <li><strong>Deslocamentos:</strong> ${statsA.movementCount}</li>
                                        <li><strong>Paradas:</strong> ${statsA.stopCount}</li>
                                        <li><strong>Top Bairro:</strong> ${statsA.topBairros[0] ? statsA.topBairros[0][0] : 'N/A'}</li>
                                        <li><strong>Hor√°rio de Pico:</strong> ${statsA.peakHours.map(h => `${h}h`).join(', ')}</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-success text-white">
                                    <h6 class="mb-0">üìÖ ${dateB}</h6>
                                </div>
                                <div class="card-body">
                                    <ul class="list-unstyled mb-0">
                                        <li><strong>Deslocamentos:</strong> ${statsB.movementCount}</li>
                                        <li><strong>Paradas:</strong> ${statsB.stopCount}</li>
                                        <li><strong>Top Bairro:</strong> ${statsB.topBairros[0] ? statsB.topBairros[0][0] : 'N/A'}</li>
                                        <li><strong>Hor√°rio de Pico:</strong> ${statsB.peakHours.map(h => `${h}h`).join(', ')}</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                ToastManager.success(`Compara√ß√£o gerada: ${dateA} vs ${dateB}`);
            }
        };

        // ========================================
        // LOCATION SEARCH MANAGER - Busca por Proximidade Geogr√°fica
        // ========================================
        const LocationSearchManager = {
            selectedDates: new Set(),
            searchResults: [],

            show() {
                const dates = AppState.getDates();
                if (dates.length === 0) {
                    ToastManager.warning('Carregue dados primeiro');
                    return;
                }

                this.renderDateSelector(dates);
                document.getElementById('location-search-section').style.display = 'block';
                document.getElementById('location-search-section').scrollIntoView({ behavior: 'smooth' });
            },

            hide() {
                document.getElementById('location-search-section').style.display = 'none';
            },

            renderDateSelector(dates) {
                const container = document.getElementById('location-search-dates');
                container.innerHTML = '';

                dates.forEach(date => {
                    const checkbox = document.createElement('div');
                    checkbox.className = 'form-check form-check-inline';
                    checkbox.innerHTML = `
                        <input class="form-check-input location-date-check" type="checkbox" value="${date}" id="loc-date-${date}">
                        <label class="form-check-label" for="loc-date-${date}">${date}</label>
                    `;
                    container.appendChild(checkbox);
                });

                // Event listener para checkboxes
                container.querySelectorAll('.location-date-check').forEach(cb => {
                    cb.addEventListener('change', (e) => {
                        if (e.target.checked) {
                            this.selectedDates.add(e.target.value);
                        } else {
                            this.selectedDates.delete(e.target.value);
                        }
                    });
                });
            },

            selectAllDates() {
                document.querySelectorAll('.location-date-check').forEach(cb => {
                    cb.checked = true;
                    this.selectedDates.add(cb.value);
                });
            },

            clearAllDates() {
                document.querySelectorAll('.location-date-check').forEach(cb => {
                    cb.checked = false;
                });
                this.selectedDates.clear();
            },

            search() {
                const lat = parseFloat(document.getElementById('search-latitude').value);
                const lon = parseFloat(document.getElementById('search-longitude').value);
                const radius = parseFloat(document.getElementById('search-radius').value);

                // Valida√ß√µes
                if (isNaN(lat) || isNaN(lon)) {
                    ToastManager.error('Informe latitude e longitude v√°lidas');
                    return;
                }

                if (!SecurityUtils.isValidBrazilCoord(lat, lon)) {
                    ToastManager.warning('Coordenadas fora do Brasil. Continuar mesmo assim?');
                }

                if (isNaN(radius) || radius < 10 || radius > 5000) {
                    ToastManager.error('Raio deve estar entre 10m e 5000m');
                    return;
                }

                if (this.selectedDates.size === 0) {
                    ToastManager.error('Selecione pelo menos um dia para buscar');
                    return;
                }

                ToastManager.info('Buscando...');
                this.searchResults = [];

                // Buscar em todos os dias selecionados
                this.selectedDates.forEach(date => {
                    const rawData = AppState.getData(date);
                    const itinerary = DataProcessor.calculateItinerary(rawData, date);

                    itinerary.forEach((segment, index) => {
                        // Usar apenas a primeira coordenada do segmento (ponto inicial)
                        // Isso garante consist√™ncia e evita duplicatas
                        if (segment.coords && segment.coords.length > 0) {
                            const coord = segment.coords[0]; // Coordenada inicial do segmento
                            const distance = DataProcessor.calculateDistance(lat, lon, coord.y, coord.x);

                            if (distance <= radius) {
                                // Encontrou um segmento dentro do raio
                                this.searchResults.push({
                                    date: date,
                                    segment: segment,
                                    segmentIndex: index,
                                    coord: coord,
                                    distance: distance,
                                    searchLat: lat,
                                    searchLon: lon
                                });
                            }
                        }
                    });
                });

                // Renderizar resultados
                this.renderResults();

                if (this.searchResults.length > 0) {
                    ToastManager.success(`${this.searchResults.length} ocorr√™ncias encontradas`);
                } else {
                    ToastManager.info('Nenhuma ocorr√™ncia encontrada no raio especificado');
                }
            },

            renderResults() {
                const resultsDiv = document.getElementById('location-search-results');
                const tbody = document.getElementById('location-search-table-body');
                const countBadge = document.getElementById('location-results-count');

                if (this.searchResults.length === 0) {
                    resultsDiv.style.display = 'none';
                    return;
                }

                resultsDiv.style.display = 'block';
                countBadge.textContent = `${this.searchResults.length} ocorr√™ncias`;

                // Limpar tabela
                tbody.innerHTML = '';

                // Ordenar por data e hora
                this.searchResults.sort((a, b) => {
                    if (a.date !== b.date) return a.date.localeCompare(b.date);
                    return a.segment.start.localeCompare(b.segment.start);
                });

                // Preencher tabela
                this.searchResults.forEach((result, index) => {
                    const segment = result.segment;
                    const tr = document.createElement('tr');

                    const durHours = Math.floor(segment.dur / 60);
                    const durMins = Math.round(segment.dur % 60);
                    const durText = durHours > 0 ? `${durHours}h ${durMins}min` : `${durMins}min`;

                    const bairro = DataProcessor.extractBairro(segment.locStart);

                    tr.innerHTML = `
                        <td>${index + 1}</td>
                        <td><span class="badge bg-primary">${result.date}</span></td>
                        <td>${segment.start}</td>
                        <td>${segment.end}</td>
                        <td><span class="badge bg-info">${durText}</span></td>
                        <td class="small">
                            <code>${result.coord.y.toFixed(6)}, ${result.coord.x.toFixed(6)}</code>
                        </td>
                        <td><span class="badge bg-success">${result.distance.toFixed(0)}m</span></td>
                        <td class="small">${SecurityUtils.sanitizeHTML(bairro)}</td>
                        <td>
                            <a href="https://www.google.com/maps/search/?api=1&query=${result.coord.y},${result.coord.x}"
                               target="_blank" class="btn btn-sm btn-outline-primary">üó∫Ô∏è</a>
                        </td>
                    `;

                    tbody.appendChild(tr);
                });
            },

            plotOnMap() {
                if (this.searchResults.length === 0) {
                    ToastManager.warning('Nenhum resultado para plotar');
                    return;
                }

                if (!MapManager.initialized) {
                    MapManager.init();
                }
                MapManager.show();
                MapManager.clear();

                const searchLat = this.searchResults[0].searchLat;
                const searchLon = this.searchResults[0].searchLon;
                const radius = parseFloat(document.getElementById('search-radius').value);

                // Plotar c√≠rculo de busca
                const circle = L.circle([searchLat, searchLon], {
                    color: '#10b981',
                    fillColor: '#10b981',
                    fillOpacity: 0.2,
                    radius: radius
                }).addTo(MapManager.map);

                // Plotar ponto central de busca
                const centerMarker = L.marker([searchLat, searchLon], {
                    icon: L.divIcon({
                        className: 'custom-div-icon',
                        html: `<div style="background-color: #10b981; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white;"></div>`,
                        iconSize: [20, 20],
                        iconAnchor: [10, 10]
                    })
                }).addTo(MapManager.map);

                centerMarker.bindPopup(`
                    <strong>üìç Ponto de Busca</strong><br>
                    Lat: ${searchLat.toFixed(6)}<br>
                    Lon: ${searchLon.toFixed(6)}<br>
                    Raio: ${radius}m
                `);

                MapManager.polylines.push(circle);
                MapManager.markers.push(centerMarker);

                // Plotar cada ocorr√™ncia
                this.searchResults.forEach((result, index) => {
                    const marker = L.circleMarker([result.coord.y, result.coord.x], {
                        radius: 8,
                        fillColor: '#ef4444',
                        color: '#fff',
                        weight: 2,
                        opacity: 1,
                        fillOpacity: 0.8
                    }).addTo(MapManager.map);

                    const durHours = Math.floor(result.segment.dur / 60);
                    const durMins = Math.round(result.segment.dur % 60);
                    const durText = durHours > 0 ? `${durHours}h ${durMins}min` : `${durMins}min`;

                    marker.bindPopup(`
                        <strong>Ocorr√™ncia #${index + 1}</strong><br>
                        <strong>Data:</strong> ${result.date}<br>
                        <strong>Hora:</strong> ${result.segment.start} - ${result.segment.end}<br>
                        <strong>Dura√ß√£o:</strong> ${durText}<br>
                        <strong>Dist√¢ncia:</strong> ${result.distance.toFixed(0)}m<br>
                        <strong>Tipo:</strong> ${result.segment.type}
                    `);

                    MapManager.markers.push(marker);
                });

                // Ajustar zoom para mostrar tudo
                MapManager.map.fitBounds(circle.getBounds(), { padding: [50, 50] });

                ToastManager.success('Resultados plotados no mapa');
            }
        };

        // ========================================
        // TOP LOCATIONS MANAGER - An√°lise de Locais Mais Visitados
        // ========================================
        const TopLocationsManager = {
            selectedDates: new Set(),
            analysisResults: [],
            cities: new Set(),

            show() {
                const dates = AppState.getDates();
                if (dates.length === 0) {
                    ToastManager.warning('Carregue dados primeiro');
                    return;
                }

                this.extractCities();
                this.renderCitySelector();
                this.renderDateSelector(dates);
                document.getElementById('top-locations-section').style.display = 'block';
                document.getElementById('top-locations-section').scrollIntoView({ behavior: 'smooth' });
            },

            hide() {
                document.getElementById('top-locations-section').style.display = 'none';
            },

            extractCities() {
                this.cities.clear();
                const dates = AppState.getDates();

                dates.forEach(date => {
                    const rawData = AppState.getData(date);
                    const itinerary = DataProcessor.calculateItinerary(rawData, date);

                    itinerary.forEach(segment => {
                        if (segment.type === 'Parada' && segment.locStart) {
                            const bairro = DataProcessor.extractBairro(segment.locStart);
                            if (bairro && bairro !== 'Desconhecido') {
                                this.cities.add(bairro);
                            }
                        }
                    });
                });
            },

            renderCitySelector() {
                const select = document.getElementById('top-locations-city');
                select.innerHTML = '<option value="">Selecione uma cidade...</option>';

                const sortedCities = Array.from(this.cities).sort();
                sortedCities.forEach(city => {
                    const option = document.createElement('option');
                    option.value = city;
                    option.textContent = city;
                    select.appendChild(option);
                });
            },

            renderDateSelector(dates) {
                const container = document.getElementById('top-locations-dates');
                container.innerHTML = '';

                dates.forEach(date => {
                    const checkbox = document.createElement('div');
                    checkbox.className = 'form-check form-check-inline';
                    checkbox.innerHTML = `
                        <input class="form-check-input top-date-check" type="checkbox" value="${date}" id="top-date-${date}">
                        <label class="form-check-label" for="top-date-${date}">${date}</label>
                    `;
                    container.appendChild(checkbox);
                });

                // Event listener para checkboxes
                container.querySelectorAll('.top-date-check').forEach(cb => {
                    cb.addEventListener('change', (e) => {
                        if (e.target.checked) {
                            this.selectedDates.add(e.target.value);
                        } else {
                            this.selectedDates.delete(e.target.value);
                        }
                    });
                });
            },

            selectAllDates() {
                document.querySelectorAll('.top-date-check').forEach(cb => {
                    cb.checked = true;
                    this.selectedDates.add(cb.value);
                });
            },

            clearAllDates() {
                document.querySelectorAll('.top-date-check').forEach(cb => {
                    cb.checked = false;
                });
                this.selectedDates.clear();
            },

            analyze() {
                const city = document.getElementById('top-locations-city').value;
                const radius = parseFloat(document.getElementById('top-locations-radius').value);
                const topN = parseInt(document.getElementById('top-locations-limit').value);

                // Valida√ß√µes
                if (!city) {
                    ToastManager.error('Selecione uma cidade');
                    return;
                }

                if (isNaN(radius) || radius < 10 || radius > 500) {
                    ToastManager.error('Raio deve estar entre 10m e 500m');
                    return;
                }

                if (this.selectedDates.size === 0) {
                    ToastManager.error('Selecione pelo menos um dia para analisar');
                    return;
                }

                ToastManager.info('Analisando locais...');

                // Coletar todas as paradas da cidade nos dias selecionados
                const stops = [];

                this.selectedDates.forEach(date => {
                    const rawData = AppState.getData(date);
                    const itinerary = DataProcessor.calculateItinerary(rawData, date);

                    itinerary.forEach(segment => {
                        if (segment.type === 'Parada' && segment.coords && segment.coords.length > 0) {
                            const bairro = DataProcessor.extractBairro(segment.locStart);

                            if (bairro === city) {
                                const coord = segment.coords[0]; // Primeira coordenada do segmento
                                stops.push({
                                    date: date,
                                    lat: coord.y,
                                    lon: coord.x,
                                    duration: segment.dur,
                                    start: segment.start,
                                    end: segment.end,
                                    location: segment.locStart,
                                    bairro: bairro
                                });
                            }
                        }
                    });
                });

                if (stops.length === 0) {
                    ToastManager.info('Nenhuma parada encontrada nesta cidade nos dias selecionados');
                    this.analysisResults = [];
                    this.renderResults();
                    return;
                }

                // Agrupar paradas pr√≥ximas (clustering por raio)
                const clusters = this.clusterByRadius(stops, radius);

                // Calcular estat√≠sticas para cada cluster
                const locations = clusters.map(cluster => {
                    const totalDuration = cluster.stops.reduce((sum, stop) => sum + stop.duration, 0);
                    const avgDuration = totalDuration / cluster.stops.length;

                    // Ordenar por data para pegar a √∫ltima visita
                    const sortedByDate = cluster.stops.sort((a, b) => {
                        if (a.date !== b.date) return b.date.localeCompare(a.date);
                        return b.start.localeCompare(a.start);
                    });

                    const lastVisit = sortedByDate[0];

                    return {
                        lat: cluster.centerLat,
                        lon: cluster.centerLon,
                        location: cluster.stops[0].location,
                        bairro: cluster.stops[0].bairro,
                        visitCount: cluster.stops.length,
                        totalDuration: totalDuration,
                        avgDuration: avgDuration,
                        lastVisitDate: lastVisit.date,
                        lastVisitTime: lastVisit.start,
                        stops: cluster.stops
                    };
                });

                // Ordenar por tempo total de parada (decrescente)
                locations.sort((a, b) => b.totalDuration - a.totalDuration);

                // Pegar apenas os Top N
                this.analysisResults = locations.slice(0, topN);

                this.renderResults();

                if (this.analysisResults.length > 0) {
                    ToastManager.success(`Top ${this.analysisResults.length} locais encontrados em ${city}`);
                } else {
                    ToastManager.info('Nenhum local encontrado');
                }
            },

            clusterByRadius(stops, radiusMeters) {
                const clusters = [];
                const assigned = new Set();

                stops.forEach((stop, index) => {
                    if (assigned.has(index)) return;

                    // Criar novo cluster
                    const cluster = {
                        stops: [stop],
                        centerLat: stop.lat,
                        centerLon: stop.lon
                    };

                    // Buscar outras paradas dentro do raio
                    stops.forEach((otherStop, otherIndex) => {
                        if (otherIndex === index || assigned.has(otherIndex)) return;

                        const distance = DataProcessor.calculateDistance(
                            stop.lat, stop.lon,
                            otherStop.lat, otherStop.lon
                        );

                        if (distance <= radiusMeters) {
                            cluster.stops.push(otherStop);
                            assigned.add(otherIndex);
                        }
                    });

                    // Calcular centroide do cluster
                    const sumLat = cluster.stops.reduce((sum, s) => sum + s.lat, 0);
                    const sumLon = cluster.stops.reduce((sum, s) => sum + s.lon, 0);
                    cluster.centerLat = sumLat / cluster.stops.length;
                    cluster.centerLon = sumLon / cluster.stops.length;

                    clusters.push(cluster);
                    assigned.add(index);
                });

                return clusters;
            },

            renderResults() {
                const resultsDiv = document.getElementById('top-locations-results');
                const tbody = document.getElementById('top-locations-table-body');
                const countBadge = document.getElementById('top-locations-count');

                if (this.analysisResults.length === 0) {
                    resultsDiv.style.display = 'none';
                    return;
                }

                resultsDiv.style.display = 'block';
                countBadge.textContent = `Top ${this.analysisResults.length} locais`;

                // Limpar tabela
                tbody.innerHTML = '';

                // Preencher tabela
                this.analysisResults.forEach((location, index) => {
                    const tr = document.createElement('tr');

                    // Formatar dura√ß√£o total
                    const totalHours = Math.floor(location.totalDuration / 60);
                    const totalMins = Math.round(location.totalDuration % 60);
                    const totalText = totalHours > 0 ? `${totalHours}h ${totalMins}min` : `${totalMins}min`;

                    // Formatar dura√ß√£o m√©dia
                    const avgHours = Math.floor(location.avgDuration / 60);
                    const avgMins = Math.round(location.avgDuration % 60);
                    const avgText = avgHours > 0 ? `${avgHours}h ${avgMins}min` : `${avgMins}min`;

                    // Classe CSS para os 3 primeiros
                    let rankClass = '';
                    if (index === 0) rankClass = 'bg-warning text-dark';
                    else if (index === 1) rankClass = 'bg-secondary text-white';
                    else if (index === 2) rankClass = 'bg-light text-dark';

                    tr.innerHTML = `
                        <td><span class="badge ${rankClass}">#${index + 1}</span></td>
                        <td class="small">
                            <code>${location.lat.toFixed(6)}, ${location.lon.toFixed(6)}</code>
                        </td>
                        <td class="small">${SecurityUtils.sanitizeHTML(location.location)}</td>
                        <td><span class="badge bg-info">${location.visitCount}</span></td>
                        <td><span class="badge bg-danger">${totalText}</span></td>
                        <td><span class="badge bg-primary">${avgText}</span></td>
                        <td class="small">${location.lastVisitDate} ${location.lastVisitTime}</td>
                        <td>
                            <a href="https://www.google.com/maps/search/?api=1&query=${location.lat},${location.lon}"
                               target="_blank" class="btn btn-sm btn-outline-primary">üó∫Ô∏è</a>
                        </td>
                    `;

                    tbody.appendChild(tr);
                });
            },

            plotOnMap() {
                if (this.analysisResults.length === 0) {
                    ToastManager.warning('Nenhum resultado para plotar');
                    return;
                }

                if (!MapManager.initialized) {
                    MapManager.init();
                }
                MapManager.show();
                MapManager.clear();

                const radius = parseFloat(document.getElementById('top-locations-radius').value);

                // Plotar cada local com numera√ß√£o
                this.analysisResults.forEach((location, index) => {
                    // Cor baseada na posi√ß√£o
                    let color = '#3b82f6'; // Azul padr√£o
                    if (index === 0) color = '#f59e0b'; // Ouro
                    else if (index === 1) color = '#6b7280'; // Prata
                    else if (index === 2) color = '#cd7f32'; // Bronze

                    // C√≠rculo representando o raio de agrupamento
                    const circle = L.circle([location.lat, location.lon], {
                        color: color,
                        fillColor: color,
                        fillOpacity: 0.1,
                        radius: radius
                    }).addTo(MapManager.map);

                    // Marker numerado no centro
                    const marker = L.marker([location.lat, location.lon], {
                        icon: L.divIcon({
                            className: 'custom-div-icon',
                            html: `
                                <div style="
                                    background-color: ${color};
                                    color: white;
                                    width: 35px;
                                    height: 35px;
                                    border-radius: 50%;
                                    border: 3px solid white;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    font-weight: bold;
                                    font-size: 16px;
                                    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                                ">#${index + 1}</div>
                            `,
                            iconSize: [35, 35],
                            iconAnchor: [17, 17]
                        })
                    }).addTo(MapManager.map);

                    // Formatar dura√ß√£o total
                    const totalHours = Math.floor(location.totalDuration / 60);
                    const totalMins = Math.round(location.totalDuration % 60);
                    const totalText = totalHours > 0 ? `${totalHours}h ${totalMins}min` : `${totalMins}min`;

                    // Formatar dura√ß√£o m√©dia
                    const avgHours = Math.floor(location.avgDuration / 60);
                    const avgMins = Math.round(location.avgDuration % 60);
                    const avgText = avgHours > 0 ? `${avgHours}h ${avgMins}min` : `${avgMins}min`;

                    marker.bindPopup(`
                        <strong>üèÜ #${index + 1} - ${location.bairro}</strong><br>
                        <strong>Local:</strong> ${location.location}<br>
                        <strong>Visitas:</strong> ${location.visitCount}<br>
                        <strong>Tempo Total:</strong> ${totalText}<br>
                        <strong>Tempo M√©dio:</strong> ${avgText}<br>
                        <strong>√öltima Visita:</strong> ${location.lastVisitDate} ${location.lastVisitTime}
                    `);

                    MapManager.polylines.push(circle);
                    MapManager.markers.push(marker);
                });

                // Ajustar zoom para mostrar todos os markers
                const bounds = L.latLngBounds(
                    this.analysisResults.map(loc => [loc.lat, loc.lon])
                );
                MapManager.map.fitBounds(bounds, { padding: [50, 50] });

                ToastManager.success('Top locais plotados no mapa');
            },

            exportResults() {
                if (this.analysisResults.length === 0) {
                    ToastManager.warning('Nenhum resultado para exportar');
                    return;
                }

                // Preparar dados para CSV
                const headers = [
                    'Posi√ß√£o',
                    'Latitude',
                    'Longitude',
                    'Local',
                    'Bairro',
                    'N¬∫ Visitas',
                    'Tempo Total (min)',
                    'Tempo M√©dio (min)',
                    '√öltima Visita (Data)',
                    '√öltima Visita (Hora)'
                ];

                const rows = this.analysisResults.map((location, index) => [
                    index + 1,
                    location.lat.toFixed(6),
                    location.lon.toFixed(6),
                    location.location,
                    location.bairro,
                    location.visitCount,
                    location.totalDuration.toFixed(1),
                    location.avgDuration.toFixed(1),
                    location.lastVisitDate,
                    location.lastVisitTime
                ]);

                // Criar CSV
                const csvContent = [headers, ...rows]
                    .map(row => row.map(cell => `"${cell}"`).join(','))
                    .join('\n');

                // Download
                const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);

                const city = document.getElementById('top-locations-city').value;
                const filename = `top_locais_${city}_${new Date().toISOString().slice(0, 10)}.csv`;

                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                ToastManager.success('CSV exportado com sucesso');
            }
        };

        // ========================================
        // TEST RUNNER - Sistema de Testes Inline
        // ========================================
        const TestRunner = {
            suites: [],
            currentSuite: null,
            results: { passed: 0, failed: 0, errors: [] },

            describe(suiteName, callback) {
                this.currentSuite = { name: suiteName, tests: [] };
                this.suites.push(this.currentSuite);
                callback();
                this.currentSuite = null;
            },

            it(testName, callback) {
                if (!this.currentSuite) {
                    console.error('it() deve ser chamado dentro de describe()');
                    return;
                }

                this.currentSuite.tests.push({ name: testName, fn: callback });
            },

            expect(actual) {
                return {
                    toBe(expected) {
                        if (actual !== expected) {
                            throw new Error(`Esperado ${expected}, mas obteve ${actual}`);
                        }
                    },
                    toEqual(expected) {
                        const actualStr = JSON.stringify(actual);
                        const expectedStr = JSON.stringify(expected);
                        if (actualStr !== expectedStr) {
                            throw new Error(`Esperado ${expectedStr}, mas obteve ${actualStr}`);
                        }
                    },
                    toHaveLength(length) {
                        if (!actual || actual.length !== length) {
                            throw new Error(`Esperado length ${length}, mas obteve ${actual?.length}`);
                        }
                    },
                    toBeGreaterThan(value) {
                        if (actual <= value) {
                            throw new Error(`Esperado valor > ${value}, mas obteve ${actual}`);
                        }
                    },
                    toBeLessThan(value) {
                        if (actual >= value) {
                            throw new Error(`Esperado valor < ${value}, mas obteve ${actual}`);
                        }
                    },
                    toContain(item) {
                        if (!actual || !actual.includes(item)) {
                            throw new Error(`Esperado que contivesse ${item}`);
                        }
                    },
                    toBeTruthy() {
                        if (!actual) {
                            throw new Error(`Esperado valor truthy, mas obteve ${actual}`);
                        }
                    },
                    toBeFalsy() {
                        if (actual) {
                            throw new Error(`Esperado valor falsy, mas obteve ${actual}`);
                        }
                    }
                };
            },

            run() {
                console.clear();
                console.log('%cüß™ EXECUTANDO TESTES...', 'font-size: 16px; font-weight: bold; color: #3b82f6');
                console.log('');

                this.results = { passed: 0, failed: 0, errors: [] };

                this.suites.forEach(suite => {
                    console.log(`%cüì¶ ${suite.name}`, 'font-weight: bold; color: #6366f1');

                    suite.tests.forEach(test => {
                        try {
                            test.fn();
                            this.results.passed++;
                            console.log(`  %c‚úÖ ${test.name}`, 'color: #22c55e');
                        } catch (error) {
                            this.results.failed++;
                            this.results.errors.push({ suite: suite.name, test: test.name, error: error.message });
                            console.log(`  %c‚ùå ${test.name}`, 'color: #ef4444');
                            console.log(`     ${error.message}`);
                        }
                    });

                    console.log('');
                });

                const total = this.results.passed + this.results.failed;
                const percent = ((this.results.passed / total) * 100).toFixed(1);

                console.log('%c‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'color: #94a3b8');
                console.log(`%cüìä RESULTADO: ${this.results.passed}/${total} passaram (${percent}%)`,
                    `font-weight: bold; color: ${this.results.failed === 0 ? '#22c55e' : '#f59e0b'}`);

                if (this.results.failed > 0) {
                    console.log(`%c‚ö†Ô∏è ${this.results.failed} teste(s) falharam`, 'color: #ef4444');
                } else {
                    console.log('%cüéâ Todos os testes passaram!', 'color: #22c55e; font-weight: bold');
                }

                return this.results;
            }
        };

        // ========================================
        // TESTES
        // ========================================

        // Teste 1: SecurityUtils
        TestRunner.describe('SecurityUtils', () => {
            TestRunner.it('deve sanitizar HTML corretamente', () => {
                const dangerous = '<script>alert(\'xss\')<\/script>';
                const sanitized = SecurityUtils.sanitizeHTML(dangerous);
                TestRunner.expect(sanitized).toContain('&lt;script&gt;');
            });

            TestRunner.it('deve validar coordenadas do Brasil', () => {
                TestRunner.expect(SecurityUtils.isValidBrazilCoord(-23.550520, -46.633308)).toBeTruthy();
                TestRunner.expect(SecurityUtils.isValidBrazilCoord(0, 0)).toBeFalsy();
                TestRunner.expect(SecurityUtils.isValidBrazilCoord(-15.7801, -47.9292)).toBeTruthy();
            });

            TestRunner.it('deve retornar string vazia para entrada nula', () => {
                TestRunner.expect(SecurityUtils.sanitizeHTML(null)).toBe('');
                TestRunner.expect(SecurityUtils.sanitizeHTML(undefined)).toBe('');
            });
        });

        // Teste 2: Utils
        TestRunner.describe('Utils', () => {
            TestRunner.it('debounce deve atrasar execu√ß√£o', (done) => {
                let called = false;
                const debouncedFn = Utils.debounce(() => { called = true; }, 100);

                debouncedFn();
                TestRunner.expect(called).toBeFalsy();

                setTimeout(() => {
                    TestRunner.expect(called).toBeTruthy();
                }, 150);
            });
        });

        // Teste 3: DataProcessor - Extra√ß√£o de Bairro
        TestRunner.describe('DataProcessor - Extra√ß√£o de Bairro', () => {
            TestRunner.it('deve extrair bairro de endere√ßo completo', () => {
                const address = 'Rua das Flores, 123 - Centro - S√£o Paulo/SP';
                const bairro = DataProcessor.extractBairro(address);
                TestRunner.expect(bairro).toBe('Centro');
            });

            TestRunner.it('deve retornar Desconhecido para endere√ßo inv√°lido', () => {
                const bairro1 = DataProcessor.extractBairro('');
                const bairro2 = DataProcessor.extractBairro(null);
                TestRunner.expect(bairro1).toBe('Desconhecido');
                TestRunner.expect(bairro2).toBe('Desconhecido');
            });

            TestRunner.it('deve lidar com varia√ß√µes de formato', () => {
                const addr1 = 'Av Principal - Jardins - SP';
                const addr2 = 'Rua ABC, Bela Vista, S√£o Paulo';
                const bairro1 = DataProcessor.extractBairro(addr1);
                const bairro2 = DataProcessor.extractBairro(addr2);
                TestRunner.expect(bairro1).toBe('Jardins');
                TestRunner.expect(bairro2).toContain('Bela Vista');
            });
        });

        // Teste 4: AppState
        TestRunner.describe('AppState', () => {
            TestRunner.it('deve armazenar e recuperar dados por data', () => {
                const testData = [{ x: -46, y: -23, l: 'Test', t: '08:00' }];
                AppState.setData('2024-01-01', testData);

                const retrieved = AppState.getData('2024-01-01');
                TestRunner.expect(retrieved).toHaveLength(1);
                TestRunner.expect(retrieved[0].l).toBe('Test');
            });

            TestRunner.it('deve retornar array vazio para data inexistente', () => {
                const data = AppState.getData('9999-12-31');
                TestRunner.expect(data).toHaveLength(0);
            });

            TestRunner.it('deve listar datas ordenadas', () => {
                AppState.setData('2024-01-03', []);
                AppState.setData('2024-01-01', []);
                AppState.setData('2024-01-02', []);

                const dates = AppState.getDates();
                TestRunner.expect(dates[0]).toBe('2024-01-01');
                TestRunner.expect(dates[1]).toBe('2024-01-02');
                TestRunner.expect(dates[2]).toBe('2024-01-03');
            });
        });

        // Teste 5: FilterManager L√≥gica
        TestRunner.describe('FilterManager', () => {
            TestRunner.it('deve filtrar dados por bairros selecionados', () => {
                const mockData = [
                    { type: 'Parada', bairro: 'Centro' },
                    { type: 'Deslocamento', bairro: 'Jardins' },
                    { type: 'Parada', bairro: 'Centro' }
                ];

                AppState.filters.selectedBairros.clear();
                AppState.filters.selectedBairros.add('Centro');

                const filtered = mockData.filter(item =>
                    AppState.filters.selectedBairros.size === 0 ||
                    AppState.filters.selectedBairros.has(item.bairro)
                );

                TestRunner.expect(filtered).toHaveLength(2);
                TestRunner.expect(filtered[0].bairro).toBe('Centro');
            });
        });

        // Teste 6: StatsManager C√°lculos
        TestRunner.describe('StatsManager - C√°lculos', () => {
            TestRunner.it('deve calcular estat√≠sticas b√°sicas corretamente', () => {
                const mockItinerary = [
                    { type: 'Deslocamento', dur: 60, km: 10 },
                    { type: 'Parada', dur: 30, km: 0 },
                    { type: 'Deslocamento', dur: 120, km: 20 }
                ];

                const stats = StatsManager.calculate(mockItinerary);

                TestRunner.expect(stats.totalMovementTime).toBe(180); // 60 + 120
                TestRunner.expect(stats.totalStopTime).toBe(30);
                TestRunner.expect(stats.totalDistance).toBe(30); // 10 + 20
                TestRunner.expect(stats.movementCount).toBe(2);
                TestRunner.expect(stats.stopCount).toBe(1);
            });

            TestRunner.it('deve calcular velocidade m√©dia corretamente', () => {
                const mockItinerary = [
                    { type: 'Deslocamento', dur: 60, km: 30 } // 60min = 1h, 30km = 30km/h
                ];

                const stats = StatsManager.calculate(mockItinerary);
                TestRunner.expect(stats.avgSpeed).toBe(30);
            });
        });

        // Fun√ß√£o global para executar testes
        window.runTests = () => TestRunner.run();

        // Log de informa√ß√£o
        console.log('%cüí° Digite window.runTests() no console para executar os testes', 'color: #3b82f6; font-weight: bold');

        // ========================================
        // INICIALIZA√á√ÉO
        // ========================================
        document.addEventListener('DOMContentLoaded', () => {
            ThemeManager.init();
            FileHandler.init();
            FilterManager.init();
            ExportManager.init();
            KeyboardManager.init();
            SearchManager.init();
            AlertsManager.init();
            CostCalculator.init();

            // Carregar filtros salvos
            const savedFilters = StorageManager.loadFilters();
            if (savedFilters) {
                AppState.filters.selectedBairros = savedFilters;
            }

            console.log('‚úÖ Analisador de Rotas V10.0 inicializado');
            console.log('üì¶ Managers: AppState, DataProcessor, UIRenderer, FilterManager, ExportManager, SearchManager, StatsManager, MapManager, AlertsManager, CostCalculator, StorageManager');
            console.log('üé® Tema:', document.documentElement.getAttribute('data-theme') || 'light');
        });
    </script>

</body>
</html>
